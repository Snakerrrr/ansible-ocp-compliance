---
# -------------------------------------------------------------------------
# EXTRACCIÓN DE KUBECONFIG (Modelo Orchestrator - AAP Native)
# Sin pipe a base64 para capturar el error real de OpenShift; decodificación con Ansible.
# -------------------------------------------------------------------------
- name: "[INIT] Obtener Secret RAW (Sin Pipe para ver errores)"
  ansible.builtin.shell: >
    oc get secret admin-kubeconfig -n {{ target_cluster_name }} -o jsonpath='{.data.kubeconfig}'
  register: raw_secret_output
  delegate_to: localhost
  ignore_errors: true
  environment:
    KUBECONFIG: "{{ lookup('env', 'KUBECONFIG') }}"

- name: "[INIT] Validar extracción"
  ansible.builtin.fail:
    msg: "FATAL: No se pudo obtener el kubeconfig para '{{ target_cluster_name }}'. Verifique el nombre del cluster y acceso al Hub. Salida: {{ raw_secret_output.stdout | default('') | trim }} {{ raw_secret_output.stderr | default('') | trim }}"
  when: raw_secret_output.stdout | default('') | length < 100

- name: "[INIT] Decodificar y guardar Kubeconfig temporal para el Spoke"
  ansible.builtin.copy:
    content: "{{ raw_secret_output.stdout | b64decode }}"
    dest: "/tmp/kubeconfig-{{ target_cluster_name }}"
    mode: '0600'
  delegate_to: localhost

- name: "[INIT] Definir variable para uso posterior"
  ansible.builtin.set_fact:
    dynamic_kubeconfig_path: "/tmp/kubeconfig-{{ target_cluster_name }}"

- name: "[INIT] Obtener infraestructura del cluster"
  kubernetes.core.k8s_info:
    api_version: config.openshift.io/v1
    kind: Infrastructure
    name: cluster
    kubeconfig: "{{ dynamic_kubeconfig_path | default(omit) }}"
  register: infra_info

- name: "[INIT] Definir variables de ejecución"
  ansible.builtin.set_fact:
    cluster_name: "{{ infra_info.resources[0].status.infrastructureName | default('DESCONOCIDO') }}"

# SECCIÓN INFORM 

- name: "[INFORM] Ejecutando revisiones de seguridad"
  ansible.builtin.include_tasks: 01_kubeadmin.yml
  when: "'ALL' in report_name or 'kubeadmin' in report_name"

- name: "[INFORM] Ejecutando revisiones de seguridad"
  ansible.builtin.include_tasks: 02_log_forwarder.yml
  when: "'ALL' in report_name or 'logs' in report_name"

- name: "[INFORM] Ejecutando revisiones de seguridad"
  ansible.builtin.include_tasks: 03_ingress_tls.yml
  when: "'ALL' in report_name or 'ingress' in report_name"

- name: "[INFORM] Ejecutando revisiones de seguridad"
  ansible.builtin.include_tasks: 04_ldap_tls.yml
  when: "'ALL' in report_name or 'ldap' in report_name"

- name: "[INFORM] Ejecutando revisiones de seguridad"
  ansible.builtin.include_tasks: 05_acs_sensor.yml
  when: "'ALL' in report_name or 'acs' in report_name"

- name: "[INFORM] Ejecutando revisiones de seguridad"
  ansible.builtin.include_tasks: 06_network_policies.yml
  when: "'ALL' in report_name or 'network' in report_name"

- name: "[INFORM] Ejecutando revisiones de seguridad"
  ansible.builtin.include_tasks: 07_oauth_timeouts_inform.yml
  when: "'ALL' in report_name or 'oauth' in report_name"

- name: "[INFORM] Ejecutando revisiones de seguridad"
  ansible.builtin.include_tasks: automatic_remediation_inform.yml
  when: "'ALL' in report_name or 'remediation' in report_name"

# FINALIZACION

- name: "[REPORT] Generar y enviar reporte consolidado"
  ansible.builtin.include_tasks: 99_send_report.yml

# ---------------------------------------------------------
# LIMPIEZA: Borrar kubeconfig temporal por seguridad
# ---------------------------------------------------------
- name: "[CLEANUP] Eliminar kubeconfig temporal"
  ansible.builtin.file:
    path: "{{ dynamic_kubeconfig_path }}"
    state: absent
  when:
    - dynamic_kubeconfig_path is defined
    - dynamic_kubeconfig_path | length > 0
  delegate_to: localhost
