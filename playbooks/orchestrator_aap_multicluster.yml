---
- name: Orquestador Multi-Cluster AAP (Compliance)
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    # --- CONFIGURACI√ìN ESTRUCTURAL (Sin datos de usuario) ---
    # Solo dejamos rutas temporales que no dependen del usuario
    export_output_dir: "/tmp/compliance-reports"
    gitops_repo_path: "/tmp/acm-policies"  # Ruta fija temporal, sin recursi√≥n
    
    # Defaults de seguridad (para que no falle si no se pasan)
    do_gitops: false
    do_export_html: false
    do_send_email: false

    # YA NO definimos github_user, github_token, email_smtp_host, etc. aqu√≠.
    # Ansible esperar√° que vengan de AAP (Extra Vars, Survey o Credentials).

  tasks:
    # ---------------------------------------------------------
    # 1. VALIDACI√ìN DE INPUTS (Sem√°foro de Seguridad)
    # ---------------------------------------------------------
    - name: Validar variables obligatorias de infraestructura Git
      assert:
        that:
          - github_user is defined
          - github_user | length > 0
          - gitops_repo_branch is defined
          - gitops_repo_branch | length > 0
          - github_token is defined
          - github_token | length > 0
        fail_msg: "‚ùå ERROR: Faltan variables de Git. Def√≠nalas en AAP (Extra Vars, Survey o Credential de Source Control)."
      when: do_gitops | bool

    - name: Validar variables obligatorias de correo
      assert:
        that:
          - email_smtp_host is defined
          - email_smtp_host | length > 0
          - email_smtp_username is defined
          - email_smtp_username | length > 0
          - email_smtp_password is defined
          - email_smtp_password | length > 0
          - email_to is defined
          - email_to | length > 0
        fail_msg: "‚ùå ERROR: Faltan variables de Correo. Def√≠nalas en AAP (Extra Vars o Survey)."
      when: do_send_email | bool

    - name: Validar flags de control
      fail:
        msg: "Al menos uno de los flags debe estar activado: do_gitops o do_export_html"
      when: not do_gitops and not do_export_html

    # ---------------------------------------------------------
    # 2. NORMALIZACI√ìN DE DATOS (Sanitizaci√≥n)
    # ---------------------------------------------------------
    - name: Normalizar lista de clusters desde AAP
      set_fact:
        # AAP a veces env√≠a la lista como string separado por comas o saltos de l√≠nea
        # Esto asegura que siempre tengamos una lista v√°lida de Python
        target_clusters_list: "{{ survey_target_clusters.split('\n') if survey_target_clusters is string else survey_target_clusters }}"
      when: survey_target_clusters is defined

    - name: Inicializar lista vac√≠a si no se defini√≥ survey_target_clusters
      set_fact:
        target_clusters_list: []
      when: survey_target_clusters is not defined

    # ---------------------------------------------------------
    # 3. DEBUG INFORMATIVO (Para ver qu√© recibi√≥ el playbook)
    # ---------------------------------------------------------
    - name: Mostrar configuraci√≥n recibida (Sin secretos)
      debug:
        msg: |
          üöÄ INICIO DE PIPELINE MULTI-CLUSTER
          ====================================
          Clusters:       {{ target_clusters_list }}
          GitOps:         {{ do_gitops }}
          Export HTML:    {{ do_export_html }}
          Enviar Correo:  {{ do_send_email }}
          User Git:       {{ github_user if (do_gitops and github_user is defined) else 'N/A' }}
          Branch:         {{ gitops_repo_branch if (do_gitops and gitops_repo_branch is defined) else 'N/A' }}
          Destinatario:   {{ email_to if (do_send_email and email_to is defined) else 'N/A' }}
          Host SMTP:      {{ email_smtp_host if (do_send_email and email_smtp_host is defined) else 'N/A' }}
          ====================================

    # ---------------------------------------------------------
    # 4. FASE GITOPS (Se ejecuta UNA vez al inicio)
    # ---------------------------------------------------------
    - name: Ejecutar Fase GitOps (Configuraci√≥n Global)
      include_role:
        name: gitops_policy_update
      vars:
        # Pasar variables directamente del playbook
        # gitops_repo_path tiene default fijo en el rol, no necesita pasarse expl√≠citamente
        # NO pasar variables de forma recursiva - el rol manejar√° los defaults
        github_token: "{{ github_token }}"
        github_user: "{{ github_user }}"
        gitops_repo_branch: "{{ gitops_repo_branch }}"
        # Estas variables se pasan solo si est√°n definidas (el rol manejar√° defaults)
        run_cis: "{{ run_cis | default(true) | bool }}"
        run_pci: "{{ run_pci | default(false) | bool }}"
        scan_remediation_action: "{{ scan_remediation_action | default('inform') }}"
        install_operator_remediation_action: "{{ install_operator_remediation_action | default('enforce') }}"
        placement_label_key: "{{ placement_label_key | default('compliance') }}"
        placement_label_value: "{{ placement_label_value | default('enabled') }}"
        placement_use_matchlabels: "{{ placement_use_matchlabels | default(true) | bool }}"
        scan_schedule: "{{ scan_schedule | default('0 2 * * *') }}"
        scan_setting_name: "{{ scan_setting_name | default('periodic-daily') }}"
      when: do_gitops | bool

    # ---------------------------------------------------------
    # 5. FASE EXTRACCI√ìN (Bucle por cada Cluster)
    # ---------------------------------------------------------
    - name: "Procesando extracci√≥n para {{ item }}"
      include_role:
        name: compliance_export_html
      vars:
        # INYECCI√ìN DIN√ÅMICA DE CONTEXTO - CR√çTICO: Usar item directamente sin default
        target_cluster_context: "{{ item }}"
        managed_cluster_name: "{{ item }}"
        # Mapear export_output_dir del playbook a compliance_reports_path del rol
        compliance_reports_path: "{{ export_output_dir | default('/tmp/compliance-reports') }}/{{ item }}"
        # Deshabilitar env√≠o de correo individual - se enviar√° al final todos juntos
        do_send_email: false
      loop: "{{ target_clusters_list }}"
      loop_control:
        loop_var: item
        label: "Cluster: {{ item }}"
      when: 
        - do_export_html | bool
        - target_clusters_list | length > 0
        - item is defined
        - item | length > 0
      # RESILIENCIA: Si falla un cluster, sigue con el siguiente
      ignore_errors: true

    # ---------------------------------------------------------
    # 6. ENV√çO CONSOLIDADO DE CORREOS (Todos los clusters juntos)
    # ---------------------------------------------------------
    - name: Buscar todos los ZIPs generados por cluster
      find:
        paths: "{{ export_output_dir }}"
        patterns: "*.zip"
        recurse: yes
        file_type: file
      register: all_zip_files
      when: 
        - do_send_email | bool
        - do_export_html | bool
        - target_clusters_list | length > 0

    - name: Construir lista de clusters procesados exitosamente
      set_fact:
        clusters_with_reports: "{{ all_zip_files.files | map('regex_replace', '.*/([^/]+)/.*\\.zip$', '\\1') | list | unique }}"
      when: 
        - do_send_email | bool
        - all_zip_files is defined
        - all_zip_files.files | length > 0

    - name: Enviar correo consolidado con todos los reportes
      community.general.mail:
        host: "{{ email_smtp_host }}"
        port: "{{ email_smtp_port }}"
        username: "{{ email_smtp_username }}"
        password: "{{ email_smtp_password }}"
        from: "{{ email_from }}"
        to: "{{ email_to }}"
        subject: "{{ email_subject_prefix }} - Reportes Multi-Cluster ({{ clusters_with_reports | default([]) | length }} clusters)"
        body: |
          Hola,
          
          Se adjuntan los reportes de cumplimiento consolidados de todos los clusters procesados.
          
          üì¶ Contenido del correo:
          {% if clusters_with_reports is defined and clusters_with_reports | length > 0 %}
          - Total de clusters procesados: {{ clusters_with_reports | length }}
          - Clusters: {{ clusters_with_reports | join(', ') }}
          {% for cluster in clusters_with_reports %}
          - Cluster {{ cluster }}: {{ all_zip_files.files | selectattr('path', 'match', '.*/' + cluster + '/.*\\.zip$') | list | length }} archivo(s) ZIP
          {% endfor %}
          {% else %}
          - No se encontraron reportes generados.
          {% endif %}
          
          Cada ZIP contiene:
          - Reportes detallados en formato HTML
          - Resumen de ejecuci√≥n (summary.txt)
          
          Nota: Los archivos XML crudos permanecen en el servidor para auditor√≠a si fueran necesarios.
          
          Saludos,
          Equipo de Automatizaci√≥n.
        attach: "{{ all_zip_files.files | map(attribute='path') | list }}"
        secure: starttls
      delegate_to: localhost
      when: 
        - do_send_email | bool
        - all_zip_files is defined
        - all_zip_files.files | length > 0
      ignore_errors: true

    # ---------------------------------------------------------
    # 7. RESUMEN FINAL
    # ---------------------------------------------------------
    - name: Resumen de ubicaci√≥n de reportes
      debug:
        msg: |
          ‚úÖ Los reportes se han guardado en: {{ export_output_dir }}/<nombre-cluster>/
          {% if do_send_email | bool and all_zip_files is defined and all_zip_files.files | length > 0 %}
          üìß Correo consolidado enviado con {{ all_zip_files.files | length }} archivo(s) de {{ clusters_with_reports | default([]) | length }} cluster(s)
          {% elif do_send_email | bool %}
          ‚ö†Ô∏è  No se encontraron reportes para enviar por correo
          {% endif %}
