#!/bin/bash
# Script para convertir resultados XML de compliance a HTML usando oscap
# Maneja archivos comprimidos (.bzip2) y los descomprime antes de convertir

OUTPUT_DIR="{{ export_output_dir }}"

echo "=========================================="
echo "Iniciando procesamiento de reportes XML → HTML"
echo "=========================================="
echo "Directorio de salida: $OUTPUT_DIR"
echo ""

# Verificar que el directorio existe
if [ ! -d "$OUTPUT_DIR" ]; then
    echo "❌ ERROR: El directorio $OUTPUT_DIR no existe"
    exit 1
fi

# Verificar herramientas necesarias
if ! command -v oscap &> /dev/null; then
    echo "❌ ERROR: oscap no está disponible"
    echo "   Instalar con: sudo apt-get install openscap-scanner"
    exit 1
fi

echo "✅ Herramientas verificadas: oscap disponible"
echo ""

# Paso 0: Copiar archivos .bzip2.out (ya descomprimidos)
echo "Paso 0: Procesando archivos .bzip2.out (ya descomprimidos)..."
OUT_COUNT=$(find "$OUTPUT_DIR" -name "*.bzip2.out" -type f 2>/dev/null | wc -l)
if [ "$OUT_COUNT" -gt 0 ]; then
    echo "Encontrados $OUT_COUNT archivo(s) .bzip2.out (ya descomprimidos)"
    find "$OUTPUT_DIR" -name "*.bzip2.out" -type f | while read out_file; do
        # Convertir archivo.xml.bzip2.out → archivo.xml (sin agregar .xml extra)
        xml_file="${out_file%.bzip2.out}"
        if [ ! -f "$xml_file" ]; then
            if cp "$out_file" "$xml_file" 2>/dev/null; then
                echo "  ✅ Copiado: $(basename "$out_file") → $(basename "$xml_file")"
            else
                echo "  ❌ Error al copiar: $(basename "$out_file")"
            fi
        else
            echo "  ⏭️  Ya existe: $(basename "$xml_file")"
        fi
    done
    echo ""
else
    echo "No se encontraron archivos .bzip2.out"
    echo ""
fi

# Paso 1: Descomprimir archivos .bzip2
echo "Paso 1: Descomprimiendo archivos .bzip2..."
BZIP2_COUNT=$(find "$OUTPUT_DIR" \( -name "*.bzip2" -o -name "*.xml.bzip2" \) -type f ! -name "*.out" 2>/dev/null | wc -l)

if [ "$BZIP2_COUNT" -gt 0 ]; then
    echo "Encontrados $BZIP2_COUNT archivo(s) comprimidos (.bzip2)"
    
    find "$OUTPUT_DIR" \( -name "*.bzip2" -o -name "*.xml.bzip2" \) -type f ! -name "*.out" | while read bzip_file; do
        # Determinar nombre del archivo XML descomprimido
        if [[ "$bzip_file" == *.xml.bzip2 ]]; then
            # Para archivos .xml.bzip2, quitar solo .bzip2 (resultado: archivo.xml)
            xml_file="${bzip_file%.bzip2}"
        else
            # Para archivos .bzip2 (sin .xml), agregar .xml
            xml_file="${bzip_file%.bzip2}.xml"
        fi
        
        # Verificar si el XML ya existe
        if [ -f "$xml_file" ]; then
            echo "  ⏭️  Ya existe: $(basename "$xml_file") (saltando descompresión)"
            continue
        fi
        
        echo "  Descomprimiendo: $(basename "$bzip_file") → $(basename "$xml_file")"
        
        # Descomprimir con bunzip2 o bzip2 -d
        if command -v bunzip2 &> /dev/null; then
            if bunzip2 -k "$bzip_file" 2>/dev/null || bzip2 -dk "$bzip_file" 2>/dev/null; then
                # Si el archivo descomprimido tiene extensión .bzip2 (sin comprimir), renombrarlo
                decompressed_file="${bzip_file%.bzip2}"
                if [ -f "$decompressed_file" ] && [ "$decompressed_file" != "$xml_file" ] && [[ "$decompressed_file" == *.bzip2 ]]; then
                    mv "$decompressed_file" "$xml_file" 2>/dev/null && echo "    ✅ Descomprimido y renombrado"
                else
                    echo "    ✅ Descomprimido"
                fi
            else
                echo "    ⚠️  Advertencia: No se pudo descomprimir $bzip_file"
            fi
        elif command -v bzip2 &> /dev/null; then
            if bzip2 -dk "$bzip_file" 2>/dev/null; then
                decompressed_file="${bzip_file%.bzip2}"
                if [ -f "$decompressed_file" ] && [ "$decompressed_file" != "$xml_file" ] && [[ "$decompressed_file" == *.bzip2 ]]; then
                    mv "$decompressed_file" "$xml_file" 2>/dev/null && echo "    ✅ Descomprimido y renombrado"
                else
                    echo "    ✅ Descomprimido"
                fi
            else
                echo "    ⚠️  Advertencia: No se pudo descomprimir $bzip_file"
            fi
        else
            echo "    ❌ Error: bunzip2 o bzip2 no están disponibles"
        fi
    done
    echo ""
fi

# Paso 2: Buscar y convertir archivos XML a HTML
echo "Paso 2: Convirtiendo archivos XML → HTML..."

# Contar archivos XML (excluyendo .bzip2 y .bzip2.out)
XML_COUNT=$(find "$OUTPUT_DIR" -name "*.xml" -type f ! -name "*.bzip2" ! -name "*.bzip2.out" 2>/dev/null | wc -l)

if [ "$XML_COUNT" -eq 0 ]; then
    echo "⚠️  Advertencia: No se encontraron archivos XML en $OUTPUT_DIR"
    echo "Esto puede indicar que los PVCs no contenían datos o hubo un error al copiarlos."
    echo ""
    echo "Buscando archivos disponibles en $OUTPUT_DIR:"
    echo "  Archivos .bzip2.out: $(find "$OUTPUT_DIR" -name "*.bzip2.out" -type f 2>/dev/null | wc -l)"
    echo "  Archivos .bzip2: $(find "$OUTPUT_DIR" -name "*.bzip2" -type f ! -name "*.out" 2>/dev/null | wc -l)"
    echo ""
    echo "Primeros archivos encontrados:"
    find "$OUTPUT_DIR" -type f \( -name "*.bzip2*" -o -name "*.xml" \) | head -10
    echo ""
    echo "Intentando procesar archivos .bzip2.out nuevamente..."
    # Intentar procesar nuevamente los .bzip2.out
    find "$OUTPUT_DIR" -name "*.bzip2.out" -type f | while read out_file; do
        xml_file="${out_file%.bzip2.out}"
        if [ ! -f "$xml_file" ]; then
            cp "$out_file" "$xml_file" 2>/dev/null && echo "  ✅ Copiado: $(basename "$out_file") → $(basename "$xml_file")"
        fi
    done
    # Recontar XML
    XML_COUNT=$(find "$OUTPUT_DIR" -name "*.xml" -type f ! -name "*.bzip2" ! -name "*.bzip2.out" 2>/dev/null | wc -l)
    if [ "$XML_COUNT" -eq 0 ]; then
        echo "❌ No se pudieron generar archivos XML. Abortando conversión."
        exit 1
    else
        echo "✅ Se generaron $XML_COUNT archivo(s) XML después del reintento"
        echo ""
    fi
fi

echo "Encontrados $XML_COUNT archivo(s) XML para convertir"
echo ""

# Buscar todos los archivos XML en subdirectorios (excluyendo .bzip2 y .bzip2.out)
find "$OUTPUT_DIR" -name "*.xml" -type f ! -name "*.bzip2" ! -name "*.bzip2.out" | while read xml_file; do
    # Obtener directorio y nombre base
    dir=$(dirname "$xml_file")
    base=$(basename "$xml_file" .xml)
    
    # Generar HTML
    html_file="$dir/${base}.html"
    
    echo "Convirtiendo: $(basename "$xml_file") → $(basename "$html_file")"
    
    # Usar oscap para generar HTML
    if oscap xccdf generate report "$xml_file" > "$html_file" 2>/dev/null; then
        echo "  ✅ Generado: $(basename "$html_file")"
    else
        echo "  ⚠️  No se pudo convertir con oscap. Intentando método alternativo..."
        # Método alternativo: usar xsltproc si está disponible
        if command -v xsltproc &> /dev/null; then
            if [ -f "/usr/share/openscap/xsl/xccdf-report.xsl" ]; then
                xsltproc /usr/share/openscap/xsl/xccdf-report.xsl "$xml_file" > "$html_file" 2>/dev/null && {
                    echo "  ✅ Generado con xsltproc: $(basename "$html_file")"
                } || {
                    echo "  ❌ Error: No se pudo convertir $xml_file"
                }
            else
                echo "  ❌ Error: Archivo XSL no encontrado en /usr/share/openscap/xsl/xccdf-report.xsl"
            fi
        else
            echo "  ❌ Error: oscap y xsltproc no disponibles para convertir $xml_file"
        fi
    fi
done

echo ""
echo "Conversión completada."
echo ""

# Resumen final
HTML_COUNT=$(find "$OUTPUT_DIR" -name "*.html" -type f 2>/dev/null | wc -l)
echo "Resumen:"
echo "  - Archivos XML procesados: $XML_COUNT"
echo "  - Archivos HTML generados: $HTML_COUNT"

