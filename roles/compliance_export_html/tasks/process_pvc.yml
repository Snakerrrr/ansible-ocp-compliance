---
# Tareas para procesar un PVC individual
# Variables esperadas:
#   pvc_name: nombre del PVC
#   pvc_type: "cis" o "pci"

- name: Definir nombre del pod extractor
  ansible.builtin.set_fact:
    pod_name: "extract-{{ pvc_name | regex_replace('^ocp4-(cis|pci-dss)-', '') | regex_replace('[^a-z0-9-]', '-') | lower }}"

- name: Crear pod extractor temporal
  ansible.builtin.template:
    src: extract-pod.yaml.j2
    dest: "/tmp/extract-{{ pvc_name }}.yaml"
  vars:
    pvc_name: "{{ pvc_name }}"
    pod_name: "{{ pod_name }}"

- name: Aplicar pod extractor
  ansible.builtin.command: oc apply -f /tmp/extract-{{ pvc_name }}.yaml -n openshift-compliance {{ oc_context_arg | default('') }}
  register: pod_apply
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path is defined and managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: Esperar a que el pod esté Running
  ansible.builtin.command: oc wait --for=condition=Ready pod/{{ pod_name }} -n openshift-compliance {{ oc_context_arg | default('') }} --timeout=60s
  ignore_errors: true
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: Crear directorio de destino en el bastión
  ansible.builtin.file:
    path: "{{ compliance_reports_path }}/{{ pvc_name }}"
    state: directory
    mode: '0755'

# --- EXTRACCIÓN ROBUSTA (Múltiples métodos de respaldo) ---
- name: Extraer resultados del PVC (Metodo 1 - oc cp - Mas estable)
  ansible.builtin.shell: |
    # Asegurar directorio local
    mkdir -p "{{ compliance_reports_path }}/{{ pvc_name }}"
    
    # Intentar copiar usando 'oc cp' (más estable que tar pipe)
    # Nota: oc cp no acepta --context directamente, usa KUBECONFIG del environment
    oc cp openshift-compliance/{{ pod_name }}:/results "{{ compliance_reports_path }}/{{ pvc_name }}/" -c extractor
  args:
    executable: /bin/bash
  register: copy_result_oc_cp
  ignore_errors: true
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: Extraer resultados del PVC (Metodo 2 - tar pipe - Fallback)
  ansible.builtin.shell: |
    oc exec -n openshift-compliance {{ pod_name }} -c extractor {{ oc_context_arg | default('') }} -- tar czf - -C /results . | tar xzf - -C {{ compliance_reports_path }}/{{ pvc_name }}
  args:
    executable: /bin/bash
  register: copy_result_tar
  ignore_errors: true
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"
  when: copy_result_oc_cp.rc != 0

- name: Verificar que la copia fue exitosa
  ansible.builtin.stat:
    path: "{{ compliance_reports_path }}/{{ pvc_name }}"
  register: copied_dir

- name: Mostrar resultado de la copia
  ansible.builtin.debug:
    msg: |
      {{ 'Copiado exitosamente' if (copied_dir.stat.exists and copied_dir.stat.isdir) else 'Error al copiar - directorio no encontrado' }}
      
      Método usado:
      - oc cp: {{ 'Exitoso' if (copy_result_oc_cp.rc | default(999) == 0) else 'Falló' if copy_result_oc_cp is defined else 'No intentado' }}
      - tar pipe: {{ 'Exitoso' if (copy_result_tar.rc | default(999) == 0) else 'Falló' if copy_result_tar is defined else 'No intentado' }}

- name: Eliminar pod extractor
  ansible.builtin.command: oc delete pod {{ pod_name }} -n openshift-compliance {{ oc_context_arg | default('') }} --ignore-not-found=true
  ignore_errors: true
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: Limpiar archivo temporal
  ansible.builtin.file:
    path: "/tmp/extract-{{ pvc_name }}.yaml"
    state: absent

