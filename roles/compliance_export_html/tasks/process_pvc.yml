---
# Tareas para procesar un PVC individual
# Variables esperadas:
#   pvc_name: nombre del PVC
#   pvc_type: "cis" o "pci"

- name: Definir nombre del pod extractor
  set_fact:
    pod_name: "extract-{{ pvc_name | regex_replace('^ocp4-(cis|pci-dss)-', '') | regex_replace('[^a-z0-9-]', '-') | lower }}"

- name: Crear pod extractor temporal
  template:
    src: extract-pod.yaml.j2
    dest: "/tmp/extract-{{ pvc_name }}.yaml"
  vars:
    pvc_name: "{{ pvc_name }}"
    pod_name: "{{ pod_name }}"

- name: üîç DEBUG - Verificar kubeconfig antes de aplicar pod
  debug:
    msg:
      - "=========================================="
      - "APLICANDO POD EXTRACTOR"
      - "=========================================="
      - "PVC: {{ pvc_name }}"
      - "managed_cluster_kubeconfig_path: {{ managed_cluster_kubeconfig_path | default('NO_DEFINIDO') }}"
      - "KUBECONFIG que se usar√°: {{ managed_cluster_kubeconfig_path if (managed_cluster_kubeconfig_path | default('') != '') else 'Contexto actual (HUB)' }}"
      - "=========================================="
  when: managed_cluster_kubeconfig_path is defined

- name: Aplicar pod extractor
  command: oc apply -f /tmp/extract-{{ pvc_name }}.yaml -n openshift-compliance {{ oc_context_arg | default('') }}
  register: pod_apply
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path is defined and managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: Esperar a que el pod est√© Running
  command: oc wait --for=condition=Ready pod/{{ pod_name }} -n openshift-compliance {{ oc_context_arg | default('') }} --timeout=60s
  ignore_errors: true
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: Crear directorio de destino en el basti√≥n
  file:
    path: "{{ compliance_reports_path }}/{{ pvc_name }}"
    state: directory
    mode: '0755'

# --- DIAGN√ìSTICO DEL POD (Ver qu√© hay dentro antes de copiar) ---
- name: üïµÔ∏è DEBUG - Listar contenido dentro del Pod Extractor
  command: >
    oc exec -n openshift-compliance {{ pod_name }} -c extractor {{ oc_context_arg | default('') }} -- ls -R /results
  register: pod_content
  ignore_errors: true
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: üïµÔ∏è DEBUG - Mostrar qu√© ve Ansible en el Pod
  debug:
    msg: 
      - "Contenido remoto en /results:"
      - "{{ pod_content.stdout_lines if pod_content.stdout_lines is defined else ['No se pudo listar contenido'] }}"
      - "RC del comando: {{ pod_content.rc | default('N/A') }}"
  when: pod_content is defined

# --- EXTRACCI√ìN ROBUSTA (M√∫ltiples m√©todos de respaldo) ---
- name: Extraer resultados del PVC (Metodo 1 - oc cp - Mas estable)
  shell: |
    # Asegurar directorio local
    mkdir -p "{{ compliance_reports_path }}/{{ pvc_name }}"
    
    # Intentar copiar usando 'oc cp' (m√°s estable que tar pipe)
    # Nota: oc cp no acepta --context directamente, usa KUBECONFIG del environment
    oc cp openshift-compliance/{{ pod_name }}:/results "{{ compliance_reports_path }}/{{ pvc_name }}/" -c extractor
  args:
    executable: /bin/bash
  register: copy_result_oc_cp
  ignore_errors: true
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"
  when: 
    - pod_content.rc == 0
    - pod_content.stdout_lines is defined
    - pod_content.stdout_lines | length > 0

- name: Extraer resultados del PVC (Metodo 2 - tar pipe - Fallback)
  shell: |
    oc exec -n openshift-compliance {{ pod_name }} -c extractor {{ oc_context_arg | default('') }} -- tar czf - -C /results . | tar xzf - -C {{ compliance_reports_path }}/{{ pvc_name }}
  args:
    executable: /bin/bash
  register: copy_result_tar
  ignore_errors: true
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"
  when: 
    - pod_content.rc == 0
    - copy_result_oc_cp.rc != 0

# --- VERIFICACI√ìN LOCAL ---
- name: üïµÔ∏è DEBUG - Ver qu√© lleg√≥ realmente al Runner
  command: "ls -R {{ compliance_reports_path }}/{{ pvc_name }}"
  register: local_content
  ignore_errors: true
  changed_when: false

- name: üïµÔ∏è DEBUG - Mostrar contenido local descargado
  debug:
    msg: 
      - "Archivos locales descargados:"
      - "{{ local_content.stdout_lines if local_content.stdout_lines is defined else ['No se encontraron archivos'] }}"
      - "Total de l√≠neas: {{ local_content.stdout_lines | length | default(0) }}"
  when: local_content is defined

- name: Verificar que la copia fue exitosa
  stat:
    path: "{{ compliance_reports_path }}/{{ pvc_name }}"
  register: copied_dir

- name: Mostrar resultado de la copia
  debug:
    msg: |
      {{ '‚úÖ Copiado exitosamente' if (copied_dir.stat.exists and copied_dir.stat.isdir) else '‚ùå Error al copiar - directorio no encontrado' }}
      
      M√©todo usado:
      - oc cp: {{ '‚úÖ Exitoso' if (copy_result_oc_cp.rc | default(999) == 0) else '‚ùå Fall√≥' if copy_result_oc_cp is defined else '‚è≠Ô∏è  No intentado' }}
      - tar pipe: {{ '‚úÖ Exitoso' if (copy_result_tar.rc | default(999) == 0) else '‚ùå Fall√≥' if copy_result_tar is defined else '‚è≠Ô∏è  No intentado' }}

- name: Eliminar pod extractor
  command: oc delete pod {{ pod_name }} -n openshift-compliance {{ oc_context_arg | default('') }} --ignore-not-found=true
  ignore_errors: true
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: Limpiar archivo temporal
  file:
    path: "/tmp/extract-{{ pvc_name }}.yaml"
    state: absent

