---
# ---------------------------------------------------------
# CONEXIÓN HUB-TO-SPOKE: Extraer kubeconfig del managed cluster desde el Hub
# ---------------------------------------------------------
- name: "[INIT] Extraer Kubeconfig del Hub para {{ target_cluster_name }}"
  ansible.builtin.shell: |
    oc get secret admin-kubeconfig -n {{ target_cluster_name }} -o jsonpath='{.data.kubeconfig}' | base64 -d
  delegate_to: localhost
  register: kubeconfig_content
  no_log: true
  failed_when: false
  when: target_cluster_name is defined and target_cluster_name | length > 0

- name: "[INIT] Validar que se obtuvo credencial"
  ansible.builtin.fail:
    msg: "No se pudo encontrar el secreto admin-kubeconfig para el cluster '{{ target_cluster_name }}'. Verifique que el nombre sea correcto y el secreto exista en el Hub."
  when:
    - target_cluster_name is defined
    - target_cluster_name | length > 0
    - kubeconfig_content is defined
    - kubeconfig_content.rc != 0 or kubeconfig_content.stdout | default('') | trim == ""

- name: "[INIT] Guardar Kubeconfig temporal"
  ansible.builtin.copy:
    content: "{{ kubeconfig_content.stdout }}"
    dest: "/tmp/kubeconfig-{{ target_cluster_name }}"
    mode: '0600'
  delegate_to: localhost
  when:
    - target_cluster_name is defined
    - target_cluster_name | length > 0
    - kubeconfig_content is defined
    - kubeconfig_content.rc == 0
    - kubeconfig_content.stdout | default('') | trim != ""

- name: "[INIT] Definir variable de ruta de conexión"
  ansible.builtin.set_fact:
    dynamic_kubeconfig_path: "/tmp/kubeconfig-{{ target_cluster_name }}"
  when:
    - target_cluster_name is defined
    - target_cluster_name | length > 0
    - kubeconfig_content is defined
    - kubeconfig_content.rc == 0
    - kubeconfig_content.stdout | default('') | trim != ""

# ---------------------------------------------------------
# Todas las tareas contra el SPOKE usan KUBECONFIG explícito
# ---------------------------------------------------------
- name: "[SPOKE] Tareas contra el clúster destino (kubeconfig descargado)"
  when: dynamic_kubeconfig_path is defined and dynamic_kubeconfig_path | length > 0
  block:
    - name: "[INIT] Obtener infraestructura del cluster"
      kubernetes.core.k8s_info:
        api_version: config.openshift.io/v1
        kind: Infrastructure
        name: cluster
        kubeconfig: "{{ dynamic_kubeconfig_path }}"
      register: infra_info

    - name: "[INIT] Definir variables de ejecución"
      ansible.builtin.set_fact:
        cluster_name: "{{ infra_info.resources[0].status.infrastructureName | default('DESCONOCIDO') }}"

    # SECCION ENFORCE - APLICACION DE CAMBIOS
    - name: "[ENFORCE] Aplicando remediaciones automáticas"
      ansible.builtin.include_tasks: remediaciones_automaticas_enforce.yaml
      when: "'ALL' in enforce_list or 'remediaciones_automaticas' in enforce_list"

    - name: "[ENFORCE] Aplicando timeouts de OAuth"
      ansible.builtin.include_tasks: 071_oauth_timeouts_enforce.yml
      when: "'ALL' in enforce_list or 'oauth' in enforce_list"

    # ENVIO DE REPORTE
    - name: "[REPORT] Generar y enviar reporte consolidado"
      ansible.builtin.include_tasks: 99_send_report.yml
  environment:
    KUBECONFIG: "{{ dynamic_kubeconfig_path }}"

# ---------------------------------------------------------
# LIMPIEZA: Borrar kubeconfig temporal por seguridad
# ---------------------------------------------------------
- name: "[CLEANUP] Eliminar kubeconfig temporal"
  ansible.builtin.file:
    path: "{{ dynamic_kubeconfig_path }}"
    state: absent
  when:
    - dynamic_kubeconfig_path is defined
    - dynamic_kubeconfig_path | length > 0
  delegate_to: localhost
