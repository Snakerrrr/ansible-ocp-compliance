---
# Playbook Unificado: compliance-pipeline.yml
# ENTRYPOINT √∫nico para toda la automatizaci√≥n de compliance OCP
#
# Flags de control:
#   do_gitops: true|false  - Ejecutar GitOps (toggle + commit + push)
#   do_export_html: true|false - Exportar resultados a HTML
#   do_send_email: true|false - Enviar reportes por correo
#
# Casos de uso:
#   1. Solo activar scans (GitOps):
#      ansible-playbook playbooks/compliance-pipeline.yml -i inventories/localhost.yml \
#        -e "do_gitops=true do_export_html=false"
#
#   2. Solo exportar HTML (healthcheck):
#      ansible-playbook playbooks/compliance-pipeline.yml -i inventories/localhost.yml \
#        -e "do_gitops=false do_export_html=true"
#
#   3. Pipeline completo:
#      ansible-playbook playbooks/compliance-pipeline.yml -i inventories/localhost.yml \
#        -e "do_gitops=true do_export_html=true do_send_email=true"

- name: Compliance Pipeline OCP (CIS + PCI DSS)
  hosts: localhost
  gather_facts: true

  vars:
    # --- CONFIGURACI√ìN DE FLUJO (Defaults seguros) ---
    # Estos valores se sobrescriben desde el Survey de AAP
    do_gitops: false
    do_export_html: false
    do_send_email: false

    # --- CONFIGURACI√ìN DE REPOSITORIO ---
    github_user: "Snakerrrr"
    gitops_repo_branch: "main"
    gitops_repo_path: "/tmp/acm-policies"
    # NOTA: 'github_token' NO debe definirse aqu√≠. Se inyecta v√≠a Credencial AAP.

    # --- CONFIGURACI√ìN DE COMPLIANCE (defaults) ---
    run_cis: true
    run_pci: true
    scan_remediation_action: "inform"
    install_operator_remediation_action: "enforce"
    
    # --- CONFIGURACI√ìN DE SCANSETTING (defaults) ---
    scan_schedule: "0 2 * * *"
    scan_setting_name: "periodic-daily"
    
    # --- CONFIGURACI√ìN DE ACM PLACEMENT (defaults) ---
    placement_label_key: "compliance"
    placement_label_value: "enabled"
    placement_use_matchlabels: true
    
    # --- CONFIGURACI√ìN DE CLUSTER CONTEXT (defaults) ---
    target_cluster_context: ""
    kubeconfig_secret_namespace: "openshift-compliance"
    managed_cluster_kubeconfigs: {}

    # --- CONFIGURACI√ìN DE CORREO (Estructural) ---
    email_smtp_host: "smtp.gmail.com"
    email_smtp_port: 587
    email_from: "robot_aap@redhat.com"
    email_subject_prefix: "Reporte de Compliance"
    email_to: "" # Se llena desde Survey
    email_smtp_username: "" # Se llena desde Survey/Secrets
    # NOTA: 'email_smtp_password' se inyecta v√≠a Extra Vars/Secrets en AAP.

    # --- RUTAS ---
    export_output_dir: "/tmp/compliance-reports"

  tasks:
    # ============================================================
    # VALIDACIONES DE SEGURIDAD
    # ============================================================
    - name: Validar inyecci√≥n de token GitHub
      assert:
        that:
          - github_token is defined
          - github_token | length > 0
        fail_msg: "CR√çTICO: No se recibi√≥ 'github_token'. Verifique que la Credencial de Git est√© adjunta al Template en AAP."
      when: do_gitops | bool

    - name: Validar credenciales de correo
      assert:
        that:
          - email_smtp_password is defined
          - email_smtp_password | length > 0
          - email_to is defined
          - email_to | length > 0
        fail_msg: "CR√çTICO: No se recibieron credenciales SMTP completas. Configure email_smtp_password y email_to en Extra Vars/Secrets de AAP."
      when: do_send_email | bool

    - name: Validar flags de control
      fail:
        msg: "Al menos uno de los flags debe estar activado: do_gitops o do_export_html"
      when: not do_gitops and not do_export_html

    # ============================================================
    # CONFIGURACI√ìN Y DEBUG INICIAL
    # ============================================================
    - name: Establecer directorio de salida con nombre de cluster (multicluster)
      set_fact:
        export_output_dir: "{{ (export_output_dir | default('/tmp/compliance-reports')) + '/' + target_cluster_context if (target_cluster_context is defined and target_cluster_context != '') else (export_output_dir | default('/tmp/compliance-reports')) }}"

    - name: Mostrar configuraci√≥n del pipeline
      debug:
        msg: |
          ========================================
          üöÄ INICIANDO PIPELINE DE COMPLIANCE
          ========================================
          - GitOps Activado: {{ do_gitops }}
          - Exportar HTML:   {{ do_export_html }}
          - Enviar Correo:   {{ do_send_email }}
          - Usuario Git:     {{ github_user }}
          - Cluster:         {{ target_cluster_context if (target_cluster_context is defined and target_cluster_context != '') else 'HUB (contexto actual)' }}
          - Placement:       {{ placement_label_key }}={{ placement_label_value }}
          ========================================

    # ============================================================
    # FASE 1: GitOps (toggle policies + commit + push)
    # ============================================================
    - name: Ejecutar GitOps (toggle + commit + push)
      when: do_gitops | bool
      block:
        - name: Actualizar scan_schedule si est√° definido
          set_fact:
            scan_schedule: "{{ scan_schedule }}"
          when: 
            - scan_schedule is defined
            - scan_schedule | length > 0

        - name: Actualizar scan_setting_name si est√° definido
          set_fact:
            scan_setting_name: "{{ scan_setting_name }}"
          when: 
            - scan_setting_name is defined
            - scan_setting_name | length > 0

        - name: Ejecutar rol gitops_policy_update
          include_role:
            name: gitops_policy_update
          vars:
            github_user: "{{ github_user }}"
            github_token: "{{ github_token }}"
            gitops_repo_path: "{{ gitops_repo_path }}"
            gitops_repo_branch: "{{ gitops_repo_branch }}"
            run_cis: "{{ run_cis }}"
            run_pci: "{{ run_pci }}"
            scan_remediation_action: "{{ scan_remediation_action }}"
            install_operator_remediation_action: "{{ install_operator_remediation_action }}"
            placement_label_key: "{{ placement_label_key }}"
            placement_label_value: "{{ placement_label_value }}"
            placement_use_matchlabels: "{{ placement_use_matchlabels }}"
            scan_schedule: "{{ scan_schedule }}"
            scan_setting_name: "{{ scan_setting_name }}"
            cis_scan_enabled: "{{ run_cis }}"
            pci_scan_enabled: "{{ run_pci }}"

        - name: Informar que GitOps se complet√≥
          debug:
            msg: "GitOps completado. ArgoCD sincronizar√° autom√°ticamente los cambios."

    # ============================================================
    # FASE 2: Esperar instalaci√≥n y completaci√≥n (nuevos clusters)
    # ============================================================
    - name: Esperar instalaci√≥n del operador y completaci√≥n de scans
      when: do_gitops | bool and do_export_html | bool
      block:
        - name: Ejecutar rol compliance_wait
          include_role:
            name: compliance_wait
          vars:
            target_cluster_context: "{{ target_cluster_context if (target_cluster_context is defined and target_cluster_context != '') else '' }}"

        - name: Informar que la espera se complet√≥
          debug:
            msg: "Espera completada. El operador est√° instalado y los scans han finalizado."

    # ============================================================
    # FASE 3: Export HTML (healthcheck informativo)
    # ============================================================
    - name: Ejecutar exportaci√≥n HTML
      when: do_export_html | bool
      block:
        - name: Ejecutar rol compliance_export_html
          include_role:
            name: compliance_export_html
          vars:
            export_output_dir: "{{ export_output_dir }}"
            target_cluster_context: "{{ target_cluster_context if (target_cluster_context is defined and target_cluster_context != '') else '' }}"
            managed_cluster_kubeconfigs: "{{ managed_cluster_kubeconfigs }}"

        - name: Informar que exportaci√≥n se complet√≥
          debug:
            msg: "Exportaci√≥n HTML completada. Reportes disponibles en: {{ export_output_dir }}"

    # ============================================================
    # FASE 4: Env√≠o de reportes por correo electr√≥nico
    # ============================================================
    # NOTA: En AAP, los Pods son ef√≠meros. Los archivos en /tmp se pierden
    # al finalizar el job. Esta fase env√≠a los reportes por correo antes
    # de que el Pod se destruya.
    - name: Enviar reportes por correo electr√≥nico
      when: 
        - do_export_html | bool
        - do_send_email | bool
      block:
        - name: Verificar disponibilidad del m√≥dulo mail
          command: python3 -c "import smtplib; import email"
          register: mail_module_check
          changed_when: false
          failed_when: false

        - name: Advertir si el m√≥dulo mail no est√° disponible
          debug:
            msg: |
              ‚ö†Ô∏è  ADVERTENCIA: El m√≥dulo mail de Ansible no est√° disponible.
              
              El m√≥dulo mail requiere las librer√≠as Python:
              - smtplib (normalmente incluida en Python est√°ndar)
              - email (normalmente incluida en Python est√°ndar)
              
              En AAP, aseg√∫rate de que tu Execution Environment tenga Python
              con estas librer√≠as disponibles.
              
              El env√≠o de correo se omitir√°.
          when: mail_module_check.rc != 0

        - name: Establecer email_from si no est√° definido
          set_fact:
            email_from: "{{ email_smtp_username }}"
          when: 
            - mail_module_check.rc == 0
            - email_from is not defined or email_from == ""

        - name: Buscar archivo ZIP generado
          find:
            paths: "{{ export_output_dir }}"
            patterns: "compliance-reports-*.zip"
            file_type: file
          register: zip_files
          failed_when: false
          when: mail_module_check.rc == 0

        - name: Buscar archivo summary.txt
          find:
            paths: "{{ export_output_dir }}"
            patterns: "summary.txt"
            file_type: file
          register: summary_files
          failed_when: false
          when: mail_module_check.rc == 0

        - name: Determinar archivo ZIP a enviar
          set_fact:
            zip_file_to_send: "{{ zip_files.files[0].path if (zip_files.files is defined and zip_files.files | length > 0) else '' }}"
            summary_file_to_send: "{{ summary_files.files[0].path if (summary_files.files is defined and summary_files.files | length > 0) else '' }}"
          when: mail_module_check.rc == 0

        - name: Advertir si no se encontr√≥ archivo ZIP
          debug:
            msg: |
              ‚ö†Ô∏è  No se encontr√≥ archivo ZIP en {{ export_output_dir }}.
              El correo se enviar√° sin adjuntos.
          when: 
            - mail_module_check.rc == 0
            - zip_file_to_send == ""

        - name: Construir asunto del correo
          set_fact:
            email_subject: "{{ email_subject_prefix }} - {{ target_cluster_context if (target_cluster_context is defined and target_cluster_context != '') else 'HUB' }} - {{ ansible_date_time.date }}"
          when: mail_module_check.rc == 0

        - name: Construir cuerpo del correo
          set_fact:
            email_body: |
              Reporte de Compliance generado exitosamente.
              
              Detalles:
              - Cluster: {{ target_cluster_context if (target_cluster_context is defined and target_cluster_context != '') else 'HUB (contexto actual)' }}
              - Fecha: {{ ansible_date_time.iso8601 }}
              - Directorio: {{ export_output_dir }}
              
              {% if zip_file_to_send != '' %}
              - Archivo ZIP adjunto: {{ zip_file_to_send | basename }}
              {% endif %}
              
              {% if summary_file_to_send != '' %}
              - Summary adjunto: {{ summary_file_to_send | basename }}
              {% endif %}
              
              Este correo fue generado autom√°ticamente por el Compliance Pipeline de Ansible.
          when: mail_module_check.rc == 0

        - name: Enviar reporte por correo (con ZIP si existe)
          mail:
            host: "{{ email_smtp_host }}"
            port: "{{ email_smtp_port }}"
            username: "{{ email_smtp_username }}"
            password: "{{ email_smtp_password }}"
            to: "{{ email_to }}"
            from: "{{ email_from }}"
            subject: "{{ email_subject }}"
            body: "{{ email_body }}"
            attach:
              - "{{ zip_file_to_send }}"
            secure: starttls
          when: 
            - mail_module_check.rc == 0
            - zip_file_to_send != ""
          ignore_errors: true
          register: email_result_zip

        - name: Enviar reporte por correo (solo summary si no hay ZIP)
          mail:
            host: "{{ email_smtp_host }}"
            port: "{{ email_smtp_port }}"
            username: "{{ email_smtp_username }}"
            password: "{{ email_smtp_password }}"
            to: "{{ email_to }}"
            from: "{{ email_from }}"
            subject: "{{ email_subject }}"
            body: "{{ email_body }}"
            attach:
              - "{{ summary_file_to_send }}"
            secure: starttls
          when: 
            - mail_module_check.rc == 0
            - zip_file_to_send == ""
            - summary_file_to_send != ""
          ignore_errors: true
          register: email_result_summary

        - name: Enviar reporte por correo (sin adjuntos si no hay archivos)
          mail:
            host: "{{ email_smtp_host }}"
            port: "{{ email_smtp_port }}"
            username: "{{ email_smtp_username }}"
            password: "{{ email_smtp_password }}"
            to: "{{ email_to }}"
            from: "{{ email_from }}"
            subject: "{{ email_subject }}"
            body: "{{ email_body }}"
            secure: starttls
          when: 
            - mail_module_check.rc == 0
            - zip_file_to_send == ""
            - summary_file_to_send == ""
          ignore_errors: true
          register: email_result_no_attach

        - name: Verificar resultado del env√≠o de correo
          set_fact:
            email_sent_successfully: >
              (email_result_zip is defined and email_result_zip.failed == false) or
              (email_result_summary is defined and email_result_summary.failed == false) or
              (email_result_no_attach is defined and email_result_no_attach.failed == false)
          when: mail_module_check.rc == 0

        - name: Informar que correo se envi√≥ exitosamente
          debug:
            msg: |
              ‚úÖ Correo enviado exitosamente a {{ email_to }}
              Asunto: {{ email_subject }}
              {% if zip_file_to_send != '' %}
              Archivo adjunto: {{ zip_file_to_send | basename }}
              {% elif summary_file_to_send != '' %}
              Archivo adjunto: {{ summary_file_to_send | basename }}
              {% endif %}
          when: 
            - mail_module_check.rc == 0
            - email_sent_successfully | default(false) | bool

        - name: Advertir si el env√≠o de correo fall√≥
          debug:
            msg: |
              ‚ö†Ô∏è  El env√≠o de correo fall√≥. Verifica:
              1. Que el m√≥dulo mail est√© disponible en el Execution Environment
              2. Que las credenciales SMTP sean correctas
              3. Que el servidor SMTP sea accesible desde AAP
              4. Que el puerto SMTP no est√© bloqueado por firewall
              
              Los reportes est√°n disponibles en: {{ export_output_dir }}
              (Nota: En AAP, estos archivos se perder√°n cuando el Pod termine)
          when: 
            - mail_module_check.rc == 0
            - not (email_sent_successfully | default(false) | bool)

    # ============================================================
    # Resumen final
    # ============================================================
    - name: Resumen final del pipeline
      debug:
        msg: |
          ========================================
          Compliance Pipeline - Ejecuci√≥n Completada
          ========================================
          GitOps ejecutado: {{ do_gitops }}
          Export HTML ejecutado: {{ do_export_html }}
          Correo enviado: {{ do_send_email if (do_export_html and do_send_email) else false }}
          ========================================
