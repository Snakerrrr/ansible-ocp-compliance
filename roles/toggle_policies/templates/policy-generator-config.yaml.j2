apiVersion: policy.open-cluster-management.io/v1
kind: PolicyGenerator
metadata:
  name: compliance-operator-policies
  # Esta fecha se actualiza sola con Ansible
  # Última actualización: {{ ansible_date_time.iso8601 }}

policyDefaults:
  namespace: policies
  remediationAction: enforce   # <--- CAMBIO 1: Forzar creación
  placement:
    labelSelector:
      matchLabels:
        "{{ placement_label_key }}": "{{ placement_label_value }}"  # <--- CAMBIO 2: Usar etiqueta dinámica

policies:
  - name: install-compliance-operator
    disabled: false
    remediationAction: enforce
    manifests:
      - path: compliance-operator/install

  - name: scan-setting-periodic
    disabled: false
    remediationAction: enforce
    manifests:
      - path: compliance-operator/scan-setting

  # Mantener la lógica dinámica de Ansible para activar/desactivar escaneos
  - name: run-cis-scan
    remediationAction: enforce
    # Aquí Ansible decide si activa o desactiva según tus variables
    disabled: {{ 'true' if not (cis_scan_enabled | default(true) | bool) else 'false' }}
    manifests:
      - path: compliance-operator/profiles/cis

  - name: run-pci-scan
    remediationAction: enforce
    disabled: {{ 'true' if not (pci_scan_enabled | default(false) | bool) else 'false' }}
    manifests:
      - path: compliance-operator/profiles/pci
