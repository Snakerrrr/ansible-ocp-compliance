---
# Timestamp sin depender de gather_facts (ansible_date_time)
- name: "[REPORT] Definir timestamp actual (compatible con gather_facts: false)"
  ansible.builtin.set_fact:
    current_timestamp: "{{ lookup('pipe', 'date +%Y-%m-%dT%H:%M:%SZ') }}"

# Generar reporte local (sin correo)
- name: "[REPORT] Crear directorio y guardar reporte TXT"
  block:
    - ansible.builtin.file: { path: "{{ report_dir }}", state: directory }
    - ansible.builtin.template:
        src: report_final.j2
        dest: "{{ report_dir }}/{{ report_file }}.txt"

# --- Subida a GitLab (reportes_controles_seguridad/<inventory_hostname>/) ---
- name: "[REPORT] Normalizar credenciales GitLab desde Environment Variables"
  ansible.builtin.set_fact:
    gitlab_token: "{{ lookup('env', 'GITLAB_TOKEN') | default(gitlab_token | default('')) }}"
    gitlab_user: "{{ lookup('env', 'GITLAB_USER') | default(gitlab_user | default('')) }}"
    cluster_report_dir: "{{ (git_workdir | default('/tmp/controles-seguridad-git')) }}/reportes_controles_seguridad/{{ inventory_hostname }}"
  when: do_push_gitlab | default(false) | bool

- name: "[REPORT] Construir URL de repositorio GitLab con autenticación"
  ansible.builtin.set_fact:
    gitlab_repo_url_auth: "{{ 'https://oauth2:' ~ gitlab_token ~ '@' ~ (gitlab_repo_url | regex_replace('^https://', '')) }}"
  when: do_push_gitlab | default(false) | bool
  no_log: true

- name: "[REPORT] Eliminar directorio de trabajo Git si existe (clone limpio)"
  ansible.builtin.file:
    path: "{{ git_workdir | default('/tmp/controles-seguridad-git') }}"
    state: absent
  when: do_push_gitlab | default(false) | bool

- name: "[REPORT] Clonar repositorio GitLab"
  ansible.builtin.git:
    repo: "{{ gitlab_repo_url_auth }}"
    dest: "{{ git_workdir | default('/tmp/controles-seguridad-git') }}"
    version: "{{ gitlab_repo_branch | default('main') }}"
    force: true
  when: do_push_gitlab | default(false) | bool
  no_log: true

- name: "[REPORT] Crear árbol de directorios (reportes_controles_seguridad/{{ inventory_hostname }})"
  ansible.builtin.file:
    path: "{{ cluster_report_dir }}"
    state: directory
    mode: "0755"
    recurse: yes
  when: do_push_gitlab | default(false) | bool

- name: "[REPORT] Copiar reporte al repo (resultado_enforce_<timestamp>.txt)"
  ansible.builtin.copy:
    src: "{{ report_dir }}/{{ report_file }}.txt"
    dest: "{{ cluster_report_dir }}/resultado_enforce_{{ current_timestamp | regex_replace(':', '-') }}.txt"
    remote_src: false
    mode: "0644"
  when: do_push_gitlab | default(false) | bool

- name: "[REPORT] Aplicar política de retención (solo en {{ cluster_report_dir }}, mantener 5 más recientes)"
  ansible.builtin.shell: |
    set -e
    cd "{{ cluster_report_dir }}"
    ls -tp 2>/dev/null | grep -v '/$' | tail -n +6 | xargs -I {} rm -- {} 2>/dev/null || true
  args:
    chdir: "{{ git_workdir | default('/tmp/controles-seguridad-git') }}"
  when: do_push_gitlab | default(false) | bool

- name: "[REPORT] Configurar usuario y email Git"
  ansible.builtin.shell: >-
    git config user.name "{{ gitlab_user }}"
    && git config user.email "{{ gitlab_user | default('ansible-bot') }}@users.noreply.gitlab.com"
  args:
    chdir: "{{ git_workdir | default('/tmp/controles-seguridad-git') }}"
  when: do_push_gitlab | default(false) | bool

- name: "[REPORT] Añadir archivos y hacer commit"
  ansible.builtin.shell: >-
    git add reportes_controles_seguridad/
    && git commit -m "Reporte enforce - {{ inventory_hostname }} - {{ current_timestamp }}"
  args:
    chdir: "{{ git_workdir | default('/tmp/controles-seguridad-git') }}"
  register: git_commit_result
  changed_when: "'nothing to commit' not in ((git_commit_result.stderr | default('')) ~ (git_commit_result.stdout | default('')))"
  failed_when: >
    git_commit_result.rc != 0
    and 'nothing to commit' not in ((git_commit_result.stderr | default('')) ~ (git_commit_result.stdout | default('')))
  when: do_push_gitlab | default(false) | bool

- name: "[REPORT] Push a GitLab"
  ansible.builtin.shell: git push origin "{{ gitlab_repo_branch | default('main') }}"
  args:
    chdir: "{{ git_workdir | default('/tmp/controles-seguridad-git') }}"
  when:
    - do_push_gitlab | default(false) | bool
    - git_commit_result is defined
    - git_commit_result.changed | default(false)
  no_log: true
