---
# Rol: gitops_policy_update
# Responsabilidad: GitOps puro (clone, toggle, commit, push)
# NO renderiza policies (eso lo hace toggle_policies)
# NO aplica manifests (eso lo hace ArgoCD/ACM)

- name: Validar que github_token está definido
  ansible.builtin.fail:
    msg: "github_token es requerido para operaciones GitOps"
  when: github_token is not defined or github_token == ""

- name: Construir URL del repo GitOps
  ansible.builtin.set_fact:
    gitops_repo_url: "https://{{ github_user }}:{{ github_token }}@github.com/{{ github_user }}/acm-policies.git"

- name: Clonar/actualizar repo GitOps (acm-policies)
  ansible.builtin.git:
    repo: "{{ gitops_repo_url }}"
    dest: "{{ gitops_repo_path }}"
    version: "{{ gitops_repo_branch }}"
    force: true

- name: Renderizar policy-generator-config.yaml vía toggle_policies
  ansible.builtin.include_role:
    name: toggle_policies
  vars:
    # Pasar variables directamente del playbook
    # gitops_repo_path NO se pasa explícitamente - toggle_policies usará su default fijo
    # Ambos roles (gitops_policy_update y toggle_policies) tienen el mismo default: "/tmp/acm-policies"
    # Convertir run_cis/run_pci a cis_disabled/pci_disabled (invertir lógica)
    cis_disabled: "{{ not (run_cis | default(true) | bool) }}"
    pci_disabled: "{{ not (run_pci | default(false) | bool) }}"
    placement_label_key: "{{ placement_label_key | default('compliance') }}"
    placement_label_value: "{{ placement_label_value | default('enabled') }}"
    placement_use_matchlabels: "{{ placement_use_matchlabels | default(true) | bool }}"
    scan_schedule: "{{ scan_schedule | default('0 1 * * *') }}"
    scan_setting_name: "{{ scan_setting_name | default('periodic-daily') }}"
    scan_remediation_action: "{{ scan_remediation_action | default('inform') }}"
    install_operator_remediation_action: "{{ install_operator_remediation_action | default('enforce') }}"

- name: Verificar si hay cambios pendientes de commit
  ansible.builtin.command: git status --porcelain
  args:
    chdir: "{{ gitops_repo_path }}"
  register: git_status
  changed_when: false

- name: Mostrar estado de git
  ansible.builtin.debug:
    msg: "Estado de git: {{ git_status.stdout if git_status.stdout != '' else 'Sin cambios' }}"

- name: Mostrar información del último commit
  ansible.builtin.command: git log -1 --oneline
  args:
    chdir: "{{ gitops_repo_path }}"
  register: last_commit
  changed_when: false

- name: Mostrar último commit
  ansible.builtin.debug:
    msg: "Último commit en repo: {{ last_commit.stdout }}"

- name: Hacer commit y push si hay cambios
  when: git_status.stdout != ""
  block:
    - name: Configurar usuario Git para el commit
      ansible.builtin.command: git config user.name "ansible-bot"
      args:
        chdir: "{{ gitops_repo_path }}"

    - name: Configurar email Git para el commit
      ansible.builtin.command: git config user.email "ansible-bot@example.com"
      args:
        chdir: "{{ gitops_repo_path }}"

    - name: Agregar todos los cambios al staging
      ansible.builtin.command: git add -A
      args:
        chdir: "{{ gitops_repo_path }}"

    - name: Hacer commit
      ansible.builtin.command: >
        git commit -m
        "Compliance GitOps update (CIS={{ run_cis | default(true) | bool }},
         PCI={{ run_pci | default(false) | bool }},
         remediation={{ scan_remediation_action | default('inform') }})"
      args:
        chdir: "{{ gitops_repo_path }}"

    - name: Hacer push (sin prompts)
      ansible.builtin.command: git push origin "{{ gitops_repo_branch }}"
      args:
        chdir: "{{ gitops_repo_path }}"
      environment:
        GIT_TERMINAL_PROMPT: "0"

    - name: Mostrar mensaje de éxito
      ansible.builtin.debug:
        msg: "Cambios GitOps aplicados exitosamente. ArgoCD sincronizará automáticamente."

- name: Informar si no hay cambios
  when: git_status.stdout == ""
  ansible.builtin.debug:
    msg: "No hay cambios en el repo GitOps. Nada que commitear."
