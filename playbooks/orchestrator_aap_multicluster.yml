---
- name: Orquestador Multi-Cluster AAP (Compliance)
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    # --- CONFIGURACIÃ“N ESTRUCTURAL (Sin datos de usuario) ---
    # Solo dejamos rutas temporales que no dependen del usuario
    export_output_dir: "/tmp/compliance-reports"
    gitops_repo_path: "/tmp/acm-policies"  # Ruta fija temporal, sin recursiÃ³n
    
    # Defaults de seguridad (para que no falle si no se pasan)
    do_gitops: false
    do_export_html: false
    do_send_email: false

    # YA NO definimos github_user, github_token, email_smtp_host, etc. aquÃ­.
    # Ansible esperarÃ¡ que vengan de AAP (Extra Vars, Survey o Credentials).

  tasks:
    # ---------------------------------------------------------
    # 1. VALIDACIÃ“N DE INPUTS (SemÃ¡foro de Seguridad)
    # ---------------------------------------------------------
    - name: Validar variables obligatorias de infraestructura Git
      assert:
        that:
          - github_user is defined
          - github_user | length > 0
          - gitops_repo_branch is defined
          - gitops_repo_branch | length > 0
          - github_token is defined
          - github_token | length > 0
        fail_msg: "âŒ ERROR: Faltan variables de Git. DefÃ­nalas en AAP (Extra Vars, Survey o Credential de Source Control)."
      when: do_gitops | bool

    - name: Validar variables obligatorias de correo
      assert:
        that:
          - email_smtp_host is defined
          - email_smtp_host | length > 0
          - email_smtp_username is defined
          - email_smtp_username | length > 0
          - email_smtp_password is defined
          - email_smtp_password | length > 0
          - email_to is defined
          - email_to | length > 0
        fail_msg: "âŒ ERROR: Faltan variables de Correo. DefÃ­nalas en AAP (Extra Vars o Survey)."
      when: do_send_email | bool

    - name: Validar flags de control
      fail:
        msg: "Al menos uno de los flags debe estar activado: do_gitops o do_export_html"
      when: not do_gitops and not do_export_html

    # ---------------------------------------------------------
    # 2. NORMALIZACIÃ“N DE DATOS (SanitizaciÃ³n)
    # ---------------------------------------------------------
    - name: Normalizar lista de clusters desde AAP
      set_fact:
        # AAP a veces envÃ­a la lista como string separado por comas o saltos de lÃ­nea
        # Esto asegura que siempre tengamos una lista vÃ¡lida de Python
        target_clusters_list: "{{ survey_target_clusters.split('\n') if survey_target_clusters is string else survey_target_clusters }}"
      when: survey_target_clusters is defined

    - name: Inicializar lista vacÃ­a si no se definiÃ³ survey_target_clusters
      set_fact:
        target_clusters_list: []
      when: survey_target_clusters is not defined

    # ---------------------------------------------------------
    # 3. DEBUG INFORMATIVO (Para ver quÃ© recibiÃ³ el playbook)
    # ---------------------------------------------------------
    - name: Mostrar configuraciÃ³n recibida (Sin secretos)
      debug:
        msg: |
          ðŸš€ INICIO DE PIPELINE MULTI-CLUSTER
          ====================================
          Clusters:       {{ target_clusters_list }}
          GitOps:         {{ do_gitops }}
          Export HTML:    {{ do_export_html }}
          Enviar Correo:  {{ do_send_email }}
          User Git:       {{ github_user if (do_gitops and github_user is defined) else 'N/A' }}
          Branch:         {{ gitops_repo_branch if (do_gitops and gitops_repo_branch is defined) else 'N/A' }}
          Destinatario:   {{ email_to if (do_send_email and email_to is defined) else 'N/A' }}
          Host SMTP:      {{ email_smtp_host if (do_send_email and email_smtp_host is defined) else 'N/A' }}
          ====================================

    # ---------------------------------------------------------
    # 4. FASE GITOPS (Se ejecuta UNA vez al inicio)
    # ---------------------------------------------------------
    - name: Ejecutar Fase GitOps (ConfiguraciÃ³n Global)
      include_role:
        name: gitops_policy_update
      vars:
        # Pasar variables directamente del playbook
        # gitops_repo_path tiene default fijo en el rol, no necesita pasarse explÃ­citamente
        # NO pasar variables de forma recursiva - el rol manejarÃ¡ los defaults
        github_token: "{{ github_token }}"
        github_user: "{{ github_user }}"
        gitops_repo_branch: "{{ gitops_repo_branch }}"
        # Estas variables se pasan solo si estÃ¡n definidas (el rol manejarÃ¡ defaults)
        run_cis: "{{ run_cis | default(true) | bool }}"
        run_pci: "{{ run_pci | default(false) | bool }}"
        scan_remediation_action: "{{ scan_remediation_action | default('inform') }}"
        install_operator_remediation_action: "{{ install_operator_remediation_action | default('enforce') }}"
        placement_label_key: "{{ placement_label_key | default('compliance') }}"
        placement_label_value: "{{ placement_label_value | default('enabled') }}"
        placement_use_matchlabels: "{{ placement_use_matchlabels | default(true) | bool }}"
        scan_schedule: "{{ scan_schedule | default('0 2 * * *') }}"
        scan_setting_name: "{{ scan_setting_name | default('periodic-daily') }}"
      when: do_gitops | bool

    # ---------------------------------------------------------
    # 5. FASE EXTRACCIÃ“N (Bucle por cada Cluster)
    # ---------------------------------------------------------
    - name: "Procesando extracciÃ³n para {{ item }}"
      include_role:
        name: compliance_export_html
      vars:
        # INYECCIÃ“N DINÃMICA DE CONTEXTO
        target_cluster_context: "{{ item }}"
        # Mapear export_output_dir del playbook a compliance_reports_path del rol
        compliance_reports_path: "{{ export_output_dir | default('/tmp/compliance-reports') }}/{{ item }}"
      loop: "{{ target_clusters_list }}"
      loop_control:
        loop_var: item
        label: "Cluster: {{ item }}"
      when: 
        - do_export_html | bool
        - target_clusters_list | length > 0
      # RESILIENCIA: Si falla un cluster, sigue con el siguiente
      ignore_errors: true

    # ---------------------------------------------------------
    # 6. RESUMEN FINAL
    # ---------------------------------------------------------
    - name: Resumen de ubicaciÃ³n de reportes
      debug:
        msg: "âœ… Los reportes se han guardado en: {{ export_output_dir }}/<nombre-cluster>/"
