---
# Crear directorio local y generar el reporte TXT (se sube después a GitLab)
- name: "[REPORT] Crear directorio y guardar reporte TXT"
  block:
    - name: Crear directorio de reportes local
      ansible.builtin.file:
        path: "{{ report_dir }}"
        state: directory
    - name: Generar archivo de reporte desde plantilla
      ansible.builtin.template:
        src: report_final.j2
        dest: "{{ report_dir }}/{{ report_file }}.txt"

# --- Variables de ruta para GitLab ---
- name: "[REPORT] Definir ruta del reporte por cluster en el repo"
  ansible.builtin.set_fact:
    cluster_report_dir: "{{ git_workdir }}/reportes_controles_seguridad/{{ target_cluster_name | default('cluster_undefined') }}"
  when: git_workdir is defined and gitlab_repo_url is defined

# --- URL de repo con autenticación OAuth2 (no_log para no exponer token) ---
- name: "[REPORT] Construir URL de repositorio GitLab con autenticación"
  ansible.builtin.set_fact:
    gitlab_repo_url_auth: "{{ 'https://oauth2:' ~ gitlab_token ~ '@' ~ (gitlab_repo_url | regex_replace('^https://', '')) }}"
  when: git_workdir is defined and gitlab_repo_url is defined and gitlab_token is defined
  no_log: true

# --- Preparar entorno Git ---
- name: "[REPORT] Eliminar directorio de trabajo Git si existe"
  ansible.builtin.file:
    path: "{{ git_workdir }}"
    state: absent
  when: git_workdir is defined and gitlab_repo_url is defined
  delegate_to: localhost

- name: "[REPORT] Clonar repositorio GitLab"
  ansible.builtin.git:
    repo: "{{ gitlab_repo_url_auth }}"
    dest: "{{ git_workdir }}"
    version: "{{ gitlab_repo_branch | default('main') }}"
    force: true
  when: git_workdir is defined and gitlab_repo_url is defined and gitlab_repo_url_auth is defined
  delegate_to: localhost
  no_log: true

- name: "[REPORT] Crear directorio del cluster en el repo"
  ansible.builtin.file:
    path: "{{ cluster_report_dir }}"
    state: directory
    mode: "0755"
  when: cluster_report_dir is defined
  delegate_to: localhost

# --- Copiar el reporte generado ---
- name: "[REPORT] Copiar reporte al repositorio clonado"
  ansible.builtin.copy:
    src: "{{ report_dir }}/{{ report_file }}.txt"
    dest: "{{ cluster_report_dir }}/{{ report_file }}.txt"
    remote_src: true
    mode: "0644"
  when: cluster_report_dir is defined
  delegate_to: localhost

# --- Limpieza: mantener solo los 5 archivos más recientes en el directorio del cluster ---
- name: "[REPORT] Mantener solo los 5 reportes más recientes por cluster"
  ansible.builtin.shell: |
    cd "{{ cluster_report_dir }}"
    n=$(ls -t 2>/dev/null | wc -l)
    if [ "$n" -gt 5 ]; then
      ls -t | tail -n +6 | xargs rm -f 2>/dev/null || true
    fi
  args:
    executable: /bin/bash
  when: cluster_report_dir is defined
  delegate_to: localhost
  changed_when: false

# --- Configurar Git y hacer commit + push ---
- name: "[REPORT] Configurar usuario Git para commit"
  ansible.builtin.command:
    cmd: git config user.name "{{ gitlab_user | default('ansible-bot') }}"
    chdir: "{{ git_workdir }}"
  when: git_workdir is defined and gitlab_repo_url is defined
  delegate_to: localhost

- name: "[REPORT] Configurar email Git para commit"
  ansible.builtin.command:
    cmd: git config user.email "{{ gitlab_user | default('ansible-bot') }}@users.noreply.gitlab.com"
    chdir: "{{ git_workdir }}"
  when: git_workdir is defined and gitlab_repo_url is defined
  delegate_to: localhost

- name: "[REPORT] Añadir archivos, commit y push a GitLab"
  ansible.builtin.shell: >-
    cd "{{ git_workdir }}"
    && git add .
    && git commit -m "Reporte Enforce - {{ target_cluster_name | default('cluster_undefined') }} - {{ ansible_date_time.iso8601 }}"
    && git push origin "{{ gitlab_repo_branch | default('main') }}"
  args:
    chdir: "{{ git_workdir }}"
  when: git_workdir is defined and gitlab_repo_url is defined
  delegate_to: localhost
  no_log: true
