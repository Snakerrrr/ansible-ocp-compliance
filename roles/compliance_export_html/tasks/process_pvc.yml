---
# Tareas para procesar un PVC individual
# Variables esperadas:
#   pvc_name: nombre del PVC
#   pvc_type: "cis" o "pci"

- name: Definir nombre del pod extractor
  set_fact:
    pod_name: "extract-{{ pvc_name | regex_replace('^ocp4-(cis|pci-dss)-', '') | regex_replace('[^a-z0-9-]', '-') | lower }}"

- name: Crear pod extractor temporal
  template:
    src: extract-pod.yaml.j2
    dest: "/tmp/extract-{{ pvc_name }}.yaml"
  vars:
    pvc_name: "{{ pvc_name }}"
    pod_name: "{{ pod_name }}"

- name: Aplicar pod extractor
  command: oc apply -f /tmp/extract-{{ pvc_name }}.yaml -n openshift-compliance {{ oc_context_arg | default('') }}
  register: pod_apply
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: Esperar a que el pod esté Running
  command: oc wait --for=condition=Ready pod/{{ pod_name }} -n openshift-compliance {{ oc_context_arg | default('') }} --timeout=60s
  ignore_errors: true
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: Crear directorio de destino en el bastión
  file:
    path: "{{ compliance_reports_path }}/{{ pvc_name }}"
    state: directory
    mode: '0755'

- name: Copiar resultados desde PVC al bastión usando tar
  shell: |
    oc exec -n openshift-compliance {{ pod_name }} -c extractor {{ oc_context_arg | default('') }} -- tar czf - -C /results . | tar xzf - -C {{ compliance_reports_path }}/{{ pvc_name }}
  args:
    executable: /bin/bash
  ignore_errors: true
  register: copy_result
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: Verificar que la copia fue exitosa
  stat:
    path: "{{ compliance_reports_path }}/{{ pvc_name }}"
  register: copied_dir

- name: Mostrar resultado de la copia
  debug:
    msg: "{{ 'Copiado exitosamente' if copied_dir.stat.exists and copied_dir.stat.isdir else 'Error al copiar - directorio no encontrado' }}"

- name: Eliminar pod extractor
  command: oc delete pod {{ pod_name }} -n openshift-compliance {{ oc_context_arg | default('') }} --ignore-not-found=true
  ignore_errors: true
  environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path | default('') != '') else {} }}"

- name: Limpiar archivo temporal
  file:
    path: "/tmp/extract-{{ pvc_name }}.yaml"
    state: absent

