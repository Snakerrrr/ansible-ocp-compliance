---
# Playbook Unificado: compliance-pipeline.yml
# ENTRYPOINT único para toda la automatización de compliance OCP
#
# Flags de control:
#   do_gitops: true|false  - Ejecutar GitOps (toggle + commit + push)
#   do_export_html: true|false - Exportar resultados a HTML
#
# Casos de uso:
#   1. Solo activar scans (GitOps):
#      ansible-playbook playbooks/compliance-pipeline.yml -i inventories/localhost.yml \
#        -e "github_token=XXX do_gitops=true do_export_html=false"
#
#   2. Solo exportar HTML (healthcheck):
#      ansible-playbook playbooks/compliance-pipeline.yml -i inventories/localhost.yml \
#        -e "do_gitops=false do_export_html=true"
#
#   3. Pipeline completo:
#      ansible-playbook playbooks/compliance-pipeline.yml -i inventories/localhost.yml \
#        -e "github_token=XXX do_gitops=true do_export_html=true"

- name: Compliance Pipeline OCP (CIS + PCI DSS)
  hosts: localhost
  gather_facts: true

  vars:
    # =========================
    # Git / GitOps configuration (defaults)
    # =========================
    github_user: "Snakerrrr"
    gitops_repo_branch: "main"
    gitops_repo_path: "/tmp/acm-policies"

    # =========================
    # Compliance behavior (defaults)
    # =========================
    run_cis: true
    run_pci: true
    scan_remediation_action: "inform"
    install_operator_remediation_action: "enforce"
    
    # =========================
    # ScanSetting configuration (defaults)
    # =========================
    # Schedule en formato cron para escaneos periódicos
    # Ejemplo: "0 2 * * *" = Todos los días a las 2:00 AM (default)
    # Ejemplo: "0 */6 * * *" = Cada 6 horas
    scan_schedule: "0 2 * * *"
    scan_setting_name: "periodic-daily"
    
    # =========================
    # ACM Placement configuration (defaults)
    # =========================
    # Label selector para determinar en qué cluster(s) aplicar las políticas
    # Ejemplo: placement_label_key=environment, placement_label_value=cluster-acs
    placement_label_key: "environment"
    placement_label_value: "cluster-acs"
    
    # =========================
    # Cluster context for export (defaults)
    # =========================
    # Cuando se ejecuta desde el HUB, especificar el contexto del cluster objetivo
    # Ejemplo: target_cluster_context=cluster-acs
    # Si está vacío, se usa el contexto actual
    target_cluster_context: ""
    
    # =========================
    # Kubeconfig Secret Configuration (defaults)
    # =========================
    # Namespace donde se almacenan los secrets con kubeconfigs de managed clusters
    # El playbook buscará automáticamente el secret: managed-cluster-kubeconfig-{target_cluster_context}
    # en este namespace. Si no existe, usará fallback a archivos locales.
    kubeconfig_secret_namespace: "openshift-compliance"
    
    # =========================
    # Managed Cluster Kubeconfigs (defaults)
    # =========================
    # Diccionario con las rutas de los kubeconfigs de los managed clusters
    # Formato: { "cluster-name": "/ruta/al/kubeconfig" }
    # Ejemplo:
    #   managed_cluster_kubeconfigs:
    #     cluster-acs: "/tmp/kubeconfig-cluster-acs"
    #     cluster-2: "/tmp/kubeconfig-cluster-2"
    # Si no se especifica, se buscará en /tmp/kubeconfig-{target_cluster_context}
    managed_cluster_kubeconfigs: {}

    # =========================
    # Export HTML configuration (defaults)
    # =========================
    export_output_dir: "/tmp/compliance-reports"

    # =========================
    # Control flags (defaults)
    # =========================
    do_gitops: false
    do_export_html: false

  tasks:
    - name: Establecer valores finales de variables
      set_fact:
        _github_user: "{{ github_user | default('Snakerrrr') }}"
        _github_token: "{{ github_token | default('') }}"
        _gitops_repo_branch: "{{ gitops_repo_branch | default('main') }}"
        _gitops_repo_path: "{{ gitops_repo_path | default('/tmp/acm-policies') }}"
        _run_cis: "{{ run_cis if run_cis is defined else true }}"
        _run_pci: "{{ run_pci if run_pci is defined else true }}"
        _scan_remediation_action: "{{ scan_remediation_action | default('inform') }}"
        _install_operator_remediation_action: "{{ install_operator_remediation_action | default('enforce') }}"
        _export_output_dir: "{{ export_output_dir | default('/tmp/compliance-reports') }}"
        _do_gitops: "{{ do_gitops | default(false) | bool }}"
        _do_export_html: "{{ do_export_html | default(false) | bool }}"
        _gitops_repo_url: "https://{{ github_user | default('Snakerrrr') }}:{{ github_token | default('') }}@github.com/{{ github_user | default('Snakerrrr') }}/acm-policies.git"
        _scan_schedule: "0 1 * * *"
        _scan_setting_name: default

    - name: Validar flags de control
      fail:
        msg: "Al menos uno de los flags debe estar activado: do_gitops o do_export_html"
      when: not _do_gitops and not _do_export_html

    - name: Mostrar configuración del pipeline
      debug:
        msg: |
          ========================================
          Configuración del Compliance Pipeline
          ========================================
          do_gitops: {{ _do_gitops }}
          do_export_html: {{ _do_export_html }}
          run_cis: {{ _run_cis }}
          run_pci: {{ _run_pci }}
          scan_remediation_action: {{ _scan_remediation_action }}
          placement_label: {{ placement_label_key | default('environment') }}={{ placement_label_value | default('cluster-acs') }}
          target_cluster_context: {{ target_cluster_context | default('(contexto actual)') }}
          ========================================

    # ============================================================
    # FASE 1: GitOps (toggle policies + commit + push)
    # ============================================================
    - name: Ejecutar GitOps (toggle + commit + push)
      when: _do_gitops | bool
      block:
        - name: Validar que github_token está definido para GitOps
          fail:
            msg: "github_token es requerido cuando do_gitops=true"
          when: _github_token == "" or github_token is not defined

        - name: Actualizar scan_schedule si está definido
          set_fact:
            _scan_schedule: "{{ scan_schedule }}"
          when: 
            - scan_schedule is defined
            - scan_schedule | length > 0

        - name: Actualizar scan_setting_name si está definido
          set_fact:
            _scan_setting_name: "{{ scan_setting_name }}"
          when: 
            - scan_setting_name is defined
            - scan_setting_name | length > 0

        - name: Ejecutar rol gitops_policy_update
          include_role:
            name: gitops_policy_update
          vars:
            github_user: "{{ _github_user }}"
            github_token: "{{ _github_token }}"
            gitops_repo_path: "{{ _gitops_repo_path }}"
            gitops_repo_branch: "{{ _gitops_repo_branch }}"
            run_cis: "{{ _run_cis }}"
            run_pci: "{{ _run_pci }}"
            scan_remediation_action: "{{ _scan_remediation_action }}"
            install_operator_remediation_action: "{{ _install_operator_remediation_action }}"
            placement_label_key: "{{ placement_label_key | default('environment') }}"
            placement_label_value: "{{ placement_label_value | default('cluster-acs') }}"
            scan_schedule: "{{ _scan_schedule }}"
            scan_setting_name: "{{ _scan_setting_name }}"

        - name: Informar que GitOps se completó
          debug:
            msg: "GitOps completado. ArgoCD sincronizará automáticamente los cambios."

    # ============================================================
    # FASE 2: Esperar instalación y completación (nuevos clusters)
    # ============================================================
    - name: Esperar instalación del operador y completación de scans
      when: _do_gitops | bool and _do_export_html | bool
      block:
        - name: Ejecutar rol compliance_wait
          include_role:
            name: compliance_wait
          vars:
            target_cluster_context: "{{ target_cluster_context | default('') }}"
            # Todas las variables de espera se establecen en el rol si no están definidas
            # No usar default() aquí para evitar recursión
            # scan_max_age_days: días máximos antes de reiniciar scans (default: 30)
            # managed_cluster_kubeconfig_path se establece en el rol si no está definido

        - name: Informar que la espera se completó
          debug:
            msg: "Espera completada. El operador está instalado y los scans han finalizado."

    # ============================================================
    # FASE 3: Export HTML (healthcheck informativo)
    # ============================================================
    - name: Ejecutar exportación HTML
      when: _do_export_html | bool
      block:
        - name: Ejecutar rol compliance_export_html
          include_role:
            name: compliance_export_html
          vars:
            export_output_dir: "{{ _export_output_dir }}"
            target_cluster_context: "{{ target_cluster_context | default('') }}"
            # managed_cluster_kubeconfigs se establece en el rol si no está definido
            # No usar default() aquí para evitar recursión

        - name: Informar que exportación se completó
          debug:
            msg: "Exportación HTML completada. Reportes disponibles en: {{ _export_output_dir }}"

    # ============================================================
    # Resumen final
    # ============================================================
    - name: Resumen final del pipeline
      debug:
        msg: |
          ========================================
          Compliance Pipeline - Ejecución Completada
          ========================================
          GitOps ejecutado: {{ _do_gitops }}
          Export HTML ejecutado: {{ _do_export_html }}
          ========================================

