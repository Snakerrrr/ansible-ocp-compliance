---
- name: Orquestador Multi-Cluster AAP (Compliance)
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    # --- Variables que vendr√°n de la Survey de AAP ---
    # survey_target_clusters: ["cluster-acs", "cluster-2"]
    # do_gitops: false
    # do_export_html: true

    # --- Defaults para evitar fallos si no se definen en AAP ---
    export_output_dir: "/tmp/compliance-reports"
    survey_target_clusters: []

  tasks:
    # ---------------------------------------------------------
    # 1. Normalizaci√≥n de Datos (Sanitizaci√≥n)
    # ---------------------------------------------------------
    - name: Normalizar lista de clusters desde AAP
      set_fact:
        # AAP a veces env√≠a la lista como string separado por comas o saltos de l√≠nea
        # Esto asegura que siempre tengamos una lista v√°lida de Python
        target_clusters_list: "{{ survey_target_clusters.split('\n') if survey_target_clusters is string else survey_target_clusters }}"
    - name: Mostrar plan de ejecuci√≥n
      debug:
        msg: |
          üöÄ Iniciando Orquestaci√≥n Multi-Cluster
          =======================================
          Clusters seleccionados: {{ target_clusters_list }}
          GitOps Activado: {{ do_gitops | default(false) }}
          Export HTML Activado: {{ do_export_html | default(true) }}

    # ---------------------------------------------------------
    # 2. FASE GITOPS (Se ejecuta UNA vez al inicio)
    # ---------------------------------------------------------
    - name: Ejecutar Fase GitOps (Configuraci√≥n Global)
      include_role:
        name: gitops_policy_update
      vars:
        # Prioridad para github_token:
        # 1. Survey (github_token) - Si el usuario lo ingresa
        # 2. Credential de Source Control (GIT_TOKEN o SCM_TOKEN) - Si est√° configurado en AAP
        # 3. Default vac√≠o
        github_token: "{{ github_token | default(lookup('env', 'GIT_TOKEN') | default(lookup('env', 'SCM_TOKEN') | default(''))) }}"
        github_user: "{{ github_user | default(lookup('env', 'GIT_USER') | default('Snakerrrr')) }}"
        gitops_repo_path: "{{ gitops_repo_path | default('/tmp/acm-policies') }}"
        gitops_repo_branch: "{{ gitops_repo_branch | default('main') }}"
        run_cis: "{{ run_cis | default(true) }}"
        run_pci: "{{ run_pci | default(false) }}"
        scan_remediation_action: "{{ scan_remediation_action | default('inform') }}"
        install_operator_remediation_action: "{{ install_operator_remediation_action | default('enforce') }}"
        placement_label_key: "{{ placement_label_key | default('compliance') }}"
        placement_label_value: "{{ placement_label_value | default('enabled') }}"
        placement_use_matchlabels: "{{ placement_use_matchlabels | default(true) }}"
        scan_schedule: "{{ scan_schedule | default('0 2 * * *') }}"
        scan_setting_name: "{{ scan_setting_name | default('periodic-daily') }}"
      when: do_gitops | default(false) | bool

    # ---------------------------------------------------------
    # 3. FASE EXTRACCI√ìN (Bucle por cada Cluster)
    # ---------------------------------------------------------
    - name: "Procesando extracci√≥n para {{ item }}"
      include_role:
        name: compliance_export_html
      vars:
        # INYECCI√ìN DIN√ÅMICA DE CONTEXTO
        target_cluster_context: "{{ item }}"
        # Forzamos la creaci√≥n de subcarpetas para no sobrescribir
        export_output_dir: "/tmp/compliance-reports/{{ item }}"
      loop: "{{ target_clusters_list }}"
      loop_control:
        loop_var: item
        label: "Cluster: {{ item }}"
      when: do_export_html | default(true) | bool
      # RESILIENCIA: Si falla un cluster, sigue con el siguiente
      ignore_errors: true

    # ---------------------------------------------------------
    # 4. RESUMEN FINAL
    # ---------------------------------------------------------
    - name: Resumen de ubicaci√≥n de reportes
      debug:
        msg: "‚úÖ Los reportes se han guardado en: /tmp/compliance-reports/<nombre-cluster>/"
