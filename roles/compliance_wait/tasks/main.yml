---
# Rol: compliance_wait
# Descripci√≥n: Espera a que el compliance-operator est√© instalado y los ComplianceScans completen
# Uso: Se ejecuta despu√©s de GitOps y antes de export HTML

- name: Establecer variables iniciales b√°sicas
  set_fact:
    target_cluster_context: "{{ target_cluster_context | default('') }}"
    managed_cluster_name: "{{ target_cluster_context }}"

- name: Establecer compliance_namespace (valor por defecto si no se pas√≥ expl√≠citamente)
  set_fact:
    _compliance_namespace: "{{ compliance_namespace if (compliance_namespace is defined and compliance_namespace != '') else 'openshift-compliance' }}"

- name: Usar compliance_namespace establecido
  set_fact:
    compliance_namespace: "{{ _compliance_namespace }}"

- name: Establecer variables de espera (sin recursi√≥n)
  set_fact:
    _wait_timeout: "{{ wait_timeout if (wait_timeout is defined and wait_timeout != '') else 3600 }}"
    _wait_interval: "{{ wait_interval if (wait_interval is defined and wait_interval != '') else 30 }}"
    _wait_for_operator: "{{ wait_for_operator if (wait_for_operator is defined) else true }}"
    _wait_for_scans: "{{ wait_for_scans if (wait_for_scans is defined) else true }}"
    _expected_scans: "{{ expected_scans if (expected_scans is defined and expected_scans != []) else ['ocp4-cis', 'ocp4-pci-dss'] }}"
    _scan_max_age_days: "{{ scan_max_age_days if (scan_max_age_days is defined and scan_max_age_days != '') else 30 }}"

- name: Usar variables de espera establecidas
  set_fact:
    wait_timeout: "{{ _wait_timeout | int }}"
    wait_interval: "{{ _wait_interval | int }}"
    wait_for_operator: "{{ _wait_for_operator | bool }}"
    wait_for_scans: "{{ _wait_for_scans | bool }}"
    expected_scans: "{{ _expected_scans }}"
    scan_max_age_days: "{{ _scan_max_age_days | int }}"

- name: Obtener kubeconfig del managed cluster (si no se pas√≥ expl√≠citamente)
  when: 
    - target_cluster_context != ''
    - managed_cluster_kubeconfig_path is not defined or (managed_cluster_kubeconfig_path is defined and managed_cluster_kubeconfig_path == '')
  block:
    - name: Buscar admin-kubeconfig (prioridad - kubeconfig del managed cluster)
      shell: |
        oc get secret admin-kubeconfig -n {{ managed_cluster_name }} -o jsonpath='{.data.kubeconfig}' 2>&1 | base64 -d || echo ""
      register: kubeconfig_from_admin
      changed_when: false
      failed_when: false

    - name: Guardar kubeconfig a archivo temporal si se encontr√≥
      copy:
        content: "{{ kubeconfig_from_admin.stdout }}"
        dest: "/tmp/kubeconfig-{{ managed_cluster_name }}"
        mode: '0600'
      when:
        - kubeconfig_from_admin.stdout is defined
        - kubeconfig_from_admin.stdout != ''
        - kubeconfig_from_admin.stdout | length > 100

    - name: Establecer ruta del kubeconfig obtenido
      set_fact:
        managed_cluster_kubeconfig_path: "/tmp/kubeconfig-{{ managed_cluster_name }}"
      when:
        - kubeconfig_from_admin.stdout is defined
        - kubeconfig_from_admin.stdout != ''
        - kubeconfig_from_admin.stdout | length > 100

- name: Determinar contexto y kubeconfig para comandos oc
  set_fact:
    oc_context_arg: "{{ '--context=' + target_cluster_context if (target_cluster_context != '') else '' }}"
    managed_cluster_kubeconfig_path: "{{ managed_cluster_kubeconfig_path | default('') }}"

- name: Configurar environment para oc (si hay kubeconfig del managed cluster)
  set_fact:
    oc_environment: "{{ {'KUBECONFIG': managed_cluster_kubeconfig_path} if (managed_cluster_kubeconfig_path is defined and managed_cluster_kubeconfig_path != '') else {} }}"

- name: Mostrar configuraci√≥n de espera
  debug:
    msg: |
      ========================================
      Configuraci√≥n de Espera de Compliance
      ========================================
      Cluster objetivo: {{ target_cluster_context if target_cluster_context != '' else '(contexto actual)' }}
      Namespace: {{ compliance_namespace }}
      Esperar operador: {{ wait_for_operator }}
      Esperar scans: {{ wait_for_scans }}
      Scans esperados: {{ expected_scans | join(', ') }}
      Timeout: {{ wait_timeout }} segundos
      Intervalo: {{ wait_interval }} segundos
      ========================================

# ============================================================
# ESPERAR INSTALACI√ìN DEL COMPLIANCE OPERATOR
# ============================================================
- name: Esperar instalaci√≥n del Compliance Operator
  when: wait_for_operator | bool
  block:
    - name: Verificar si el Compliance Operator ya est√° instalado
      shell: |
        oc {{ oc_context_arg }} get csv -n {{ compliance_namespace }} -o jsonpath='{.items[?(@.metadata.name=~"compliance-operator.*")].metadata.name}' 2>&1 | head -1 || \
        oc {{ oc_context_arg }} get csv -n openshift-operators -o jsonpath='{.items[?(@.metadata.name=~"compliance-operator.*")].metadata.name}' 2>&1 | head -1 || \
        oc {{ oc_context_arg }} get subscription -n {{ compliance_namespace }} -o jsonpath='{.items[?(@.spec.name=="compliance-operator")].metadata.name}' 2>&1 | head -1 || \
        oc {{ oc_context_arg }} get subscription -n openshift-operators -o jsonpath='{.items[?(@.spec.name=="compliance-operator")].metadata.name}' 2>&1 | head -1 || \
        echo ""
      register: operator_check
      changed_when: false
      failed_when: false
      environment: "{{ oc_environment if (oc_environment is defined and oc_environment != {}) else {} }}"
      when: target_cluster_context != ''

    - name: Verificar si el Compliance Operator ya est√° instalado (contexto actual)
      shell: |
        oc get csv -n {{ compliance_namespace }} -o jsonpath='{.items[?(@.metadata.name=~"compliance-operator.*")].metadata.name}' 2>&1 | head -1 || \
        oc get csv -n openshift-operators -o jsonpath='{.items[?(@.metadata.name=~"compliance-operator.*")].metadata.name}' 2>&1 | head -1 || \
        oc get subscription -n {{ compliance_namespace }} -o jsonpath='{.items[?(@.spec.name=="compliance-operator")].metadata.name}' 2>&1 | head -1 || \
        oc get subscription -n openshift-operators -o jsonpath='{.items[?(@.spec.name=="compliance-operator")].metadata.name}' 2>&1 | head -1 || \
        echo ""
      register: operator_check
      changed_when: false
      failed_when: false
      when: target_cluster_context == ''

    - name: Inicializar operator_check si no se ejecut√≥ ninguna verificaci√≥n
      set_fact:
        operator_check:
          stdout: ""
      when: operator_check is not defined

    - name: Esperar instalaci√≥n del Compliance Operator (loop con timeout)
      shell: |
        OPERATOR_FOUND=""
        for ns in {{ compliance_namespace }} openshift-operators; do
          CSV=$(oc {{ oc_context_arg }} get csv -n "$ns" -o jsonpath='{.items[?(@.metadata.name=~"compliance-operator.*")].metadata.name}' 2>&1 | head -1)
          if [ -n "$CSV" ]; then
            STATUS=$(oc {{ oc_context_arg }} get csv "$CSV" -n "$ns" -o jsonpath='{.status.phase}' 2>&1)
            if [ "$STATUS" = "Succeeded" ]; then
              OPERATOR_FOUND="$CSV"
              break
            fi
          fi
        done
        if [ -z "$OPERATOR_FOUND" ]; then
          for ns in {{ compliance_namespace }} openshift-operators; do
            SUB=$(oc {{ oc_context_arg }} get subscription -n "$ns" -o jsonpath='{.items[?(@.spec.name=="compliance-operator")].metadata.name}' 2>&1 | head -1)
            if [ -n "$SUB" ]; then
              OPERATOR_FOUND="subscription-$SUB"
              break
            fi
          done
        fi
        echo "$OPERATOR_FOUND"
      register: operator_status
      changed_when: false
      failed_when: false
      until: operator_status.stdout != ""
      retries: "{{ ((wait_timeout | int) / (wait_interval | int)) | int }}"
      delay: "{{ wait_interval | int }}"
      environment: "{{ oc_environment if (oc_environment is defined and oc_environment != {}) else {} }}"
      when: 
        - target_cluster_context != ''
        - operator_check is defined
        - (operator_check.stdout | default('')) == ""

    - name: Esperar instalaci√≥n del Compliance Operator (contexto actual, loop con timeout)
      shell: |
        OPERATOR_FOUND=""
        for ns in {{ compliance_namespace }} openshift-operators; do
          CSV=$(oc get csv -n "$ns" -o jsonpath='{.items[?(@.metadata.name=~"compliance-operator.*")].metadata.name}' 2>&1 | head -1)
          if [ -n "$CSV" ]; then
            STATUS=$(oc get csv "$CSV" -n "$ns" -o jsonpath='{.status.phase}' 2>&1)
            if [ "$STATUS" = "Succeeded" ]; then
              OPERATOR_FOUND="$CSV"
              break
            fi
          fi
        done
        if [ -z "$OPERATOR_FOUND" ]; then
          for ns in {{ compliance_namespace }} openshift-operators; do
            SUB=$(oc get subscription -n "$ns" -o jsonpath='{.items[?(@.spec.name=="compliance-operator")].metadata.name}' 2>&1 | head -1)
            if [ -n "$SUB" ]; then
              OPERATOR_FOUND="subscription-$SUB"
              break
            fi
          done
        fi
        echo "$OPERATOR_FOUND"
      register: operator_status
      changed_when: false
      failed_when: false
      until: operator_status.stdout != ""
      retries: "{{ ((wait_timeout | int) / (wait_interval | int)) | int }}"
      delay: "{{ wait_interval | int }}"
      when: 
        - target_cluster_context == ''
        - operator_check is defined
        - operator_check.stdout is defined
        - operator_check.stdout == ""

    - name: Informar que el Compliance Operator est√° instalado
      debug:
        msg: "‚úÖ Compliance Operator instalado y funcionando en el namespace {{ compliance_namespace }}. {{ 'Detalles: ' + operator_status.stdout if (operator_status is defined and operator_status.stdout is defined and operator_status.stdout != '') else 'Verificado correctamente.' }}"

# ============================================================
# ESPERAR CREACI√ìN Y COMPLETACI√ìN DE COMPLIANCE SCANS
# ============================================================
- name: Esperar creaci√≥n y completaci√≥n de ComplianceScans
  when: wait_for_scans | bool
  block:
    - name: Verificar estado de ComplianceSuites y antig√ºedad (si es necesario)
      shell: |
        SUITES_STATUS=""
        CURRENT_TIME=$(date +%s)
        MAX_AGE_DAYS={{ scan_max_age_days }}
        MAX_AGE_SECONDS=$((MAX_AGE_DAYS * 24 * 60 * 60))
        SUITES_TO_RESCAN=""
        
        # Buscar ComplianceSuites relacionadas con los scans esperados
        SUITES=$(oc {{ oc_context_arg }} get compliancesuites -n {{ compliance_namespace }} -o jsonpath='{.items[*].metadata.name}' 2>&1 || echo "")
        
        if [ -z "$SUITES" ]; then
          echo "no_suites"
        else
          ALL_DONE=true
          for suite in $SUITES; do
            PHASE=$(oc {{ oc_context_arg }} get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.status.phase}' 2>&1 || echo "PENDING")
            if [ "$PHASE" != "DONE" ]; then
              ALL_DONE=false
              break
            else
              # Si est√° DONE, verificar antig√ºedad opcionalmente
              CREATION_TIMESTAMP=$(oc {{ oc_context_arg }} get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.metadata.creationTimestamp}' 2>&1 || echo "")
              if [ -n "$CREATION_TIMESTAMP" ]; then
                CREATION_TIME=$(date -d "$CREATION_TIMESTAMP" +%s 2>/dev/null || echo "0")
                if [ "$CREATION_TIME" != "0" ]; then
                  AGE_SECONDS=$((CURRENT_TIME - CREATION_TIME))
                  if [ $AGE_SECONDS -gt $MAX_AGE_SECONDS ]; then
                    SUITES_TO_RESCAN="$SUITES_TO_RESCAN $suite"
                  fi
                fi
              fi
            fi
          done
          
          if [ "$ALL_DONE" = "true" ] && [ -z "$SUITES_TO_RESCAN" ]; then
            echo "all_done"
          elif [ "$ALL_DONE" = "true" ] && [ -n "$SUITES_TO_RESCAN" ]; then
            echo "done_but_old:$SUITES_TO_RESCAN" | xargs
          else
            echo "not_done"
          fi
        fi
      register: suites_status_check
      changed_when: false
      failed_when: false
      environment: "{{ oc_environment if (oc_environment is defined and oc_environment != {}) else {} }}"
      when: target_cluster_context != ''

    - name: Verificar estado de ComplianceSuites y antig√ºedad (contexto actual, si es necesario)
      shell: |
        SUITES_STATUS=""
        CURRENT_TIME=$(date +%s)
        MAX_AGE_DAYS={{ scan_max_age_days }}
        MAX_AGE_SECONDS=$((MAX_AGE_DAYS * 24 * 60 * 60))
        SUITES_TO_RESCAN=""
        
        # Buscar ComplianceSuites relacionadas con los scans esperados
        SUITES=$(oc get compliancesuites -n {{ compliance_namespace }} -o jsonpath='{.items[*].metadata.name}' 2>&1 || echo "")
        
        if [ -z "$SUITES" ]; then
          echo "no_suites"
        else
          ALL_DONE=true
          for suite in $SUITES; do
            PHASE=$(oc get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.status.phase}' 2>&1 || echo "PENDING")
            if [ "$PHASE" != "DONE" ]; then
              ALL_DONE=false
              break
            else
              # Si est√° DONE, verificar antig√ºedad opcionalmente
              CREATION_TIMESTAMP=$(oc get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.metadata.creationTimestamp}' 2>&1 || echo "")
              if [ -n "$CREATION_TIMESTAMP" ]; then
                CREATION_TIME=$(date -d "$CREATION_TIMESTAMP" +%s 2>/dev/null || echo "0")
                if [ "$CREATION_TIME" != "0" ]; then
                  AGE_SECONDS=$((CURRENT_TIME - CREATION_TIME))
                  if [ $AGE_SECONDS -gt $MAX_AGE_SECONDS ]; then
                    SUITES_TO_RESCAN="$SUITES_TO_RESCAN $suite"
                  fi
                fi
              fi
            fi
          done
          
          if [ "$ALL_DONE" = "true" ] && [ -z "$SUITES_TO_RESCAN" ]; then
            echo "all_done"
          elif [ "$ALL_DONE" = "true" ] && [ -n "$SUITES_TO_RESCAN" ]; then
            echo "done_but_old:$SUITES_TO_RESCAN" | xargs
          else
            echo "not_done"
          fi
        fi
      register: suites_status_check
      changed_when: false
      failed_when: false
      when: target_cluster_context == ''

    - name: Forzar re-scan de ComplianceSuites antiguas usando anotaciones
      shell: |
        SUITES_LIST=$(echo "{{ suites_status_check.stdout }}" | sed 's/done_but_old://' | xargs)
        if [ -n "$SUITES_LIST" ]; then
          for suite in $SUITES_LIST; do
            if [ -n "$suite" ]; then
              echo "Agregando anotaci√≥n de re-scan a suite: $suite"
              oc {{ oc_context_arg }} annotate compliancesuite "$suite" -n {{ compliance_namespace }} compliance.openshift.io/rescan=$(date +%s) --overwrite 2>&1 || true
            fi
          done
          echo "Anotaciones de re-scan agregadas. El operador actualizar√° los resultados en los mismos PVCs."
        else
          echo "No hay suites antiguas para re-scan."
        fi
      register: suites_rescanned
      changed_when: suites_rescanned.stdout is defined and (suites_rescanned.stdout | regex_search('Agregando anotaci√≥n'))
      failed_when: false
      environment: "{{ oc_environment if (oc_environment is defined and oc_environment != {}) else {} }}"
      when: 
        - target_cluster_context != ''
        - suites_status_check.stdout is defined
        - suites_status_check.stdout != ''
        - suites_status_check.stdout | regex_search('done_but_old')

    - name: Forzar re-scan de ComplianceSuites antiguas usando anotaciones (contexto actual)
      shell: |
        SUITES_LIST=$(echo "{{ suites_status_check.stdout }}" | sed 's/done_but_old://' | xargs)
        if [ -n "$SUITES_LIST" ]; then
          for suite in $SUITES_LIST; do
            if [ -n "$suite" ]; then
              echo "Agregando anotaci√≥n de re-scan a suite: $suite"
              oc annotate compliancesuite "$suite" -n {{ compliance_namespace }} compliance.openshift.io/rescan=$(date +%s) --overwrite 2>&1 || true
            fi
          done
          echo "Anotaciones de re-scan agregadas. El operador actualizar√° los resultados en los mismos PVCs."
        else
          echo "No hay suites antiguas para re-scan."
        fi
      register: suites_rescanned
      changed_when: suites_rescanned.stdout is defined and (suites_rescanned.stdout | regex_search('Agregando anotaci√≥n'))
      failed_when: false
      when: 
        - target_cluster_context == ''
        - suites_status_check.stdout is defined
        - suites_status_check.stdout != ''
        - suites_status_check.stdout | regex_search('done_but_old')

    - name: Informar sobre reinicio de scans antiguos
      debug:
        msg: "üîÑ Scans antiguos detectados y eliminados. Se crear√°n nuevos scans autom√°ticamente: {{ scans_to_restart.stdout }}"
      when:
        - scans_to_restart.stdout is defined
        - scans_to_restart.stdout != ''
        - scans_to_restart.stdout | trim != ''

    - name: Informar que ComplianceSuites est√°n completas y son recientes
      debug:
        msg: "‚úÖ ComplianceSuites est√°n completas (DONE) y son recientes (menos de {{ scan_max_age_days }} d√≠as). Continuando sin esperar nuevos scans."
      when:
        - suites_status_check.stdout is defined
        - suites_status_check.stdout == 'all_done'

    - name: Informar que se forz√≥ re-scan de ComplianceSuites antiguas
      debug:
        msg: "üîÑ ComplianceSuites completas pero antiguas (m√°s de {{ scan_max_age_days }} d√≠as). Se agreg√≥ anotaci√≥n de re-scan. Esperando a que el operador actualice los resultados en los mismos PVCs."
      when:
        - suites_rescanned.stdout is defined
        - suites_rescanned.stdout is defined
        - suites_rescanned.stdout | regex_search('Agregando anotaci√≥n')

    - name: Esperar re-scan de ComplianceSuites despu√©s de agregar anotaci√≥n
      shell: |
        ALL_SUITES_DONE=true
        SUITES_LIST=$(echo "{{ suites_status_check.stdout }}" | sed 's/done_but_old://' | xargs)
        for suite in $SUITES_LIST; do
          if [ -n "$suite" ]; then
            PHASE=$(oc {{ oc_context_arg }} get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.status.phase}' 2>&1 || echo "PENDING")
            if [ "$PHASE" != "DONE" ]; then
              ALL_SUITES_DONE=false
              break
            fi
          fi
        done
        if [ "$ALL_SUITES_DONE" = "true" ]; then
          echo "all_done"
        else
          echo "waiting"
        fi
      register: rescanned_suites_status
      changed_when: false
      failed_when: false
      until: rescanned_suites_status.stdout == "all_done"
      retries: "{{ ((wait_timeout | int) / (wait_interval | int)) | int }}"
      delay: "{{ wait_interval | int }}"
      environment: "{{ oc_environment if (oc_environment is defined and oc_environment != {}) else {} }}"
      when: 
        - target_cluster_context != ''
        - suites_rescanned.stdout is defined
        - suites_rescanned.stdout is defined
        - suites_rescanned.stdout | regex_search('Agregando anotaci√≥n')

    - name: Esperar re-scan de ComplianceSuites despu√©s de agregar anotaci√≥n (contexto actual)
      shell: |
        ALL_SUITES_DONE=true
        SUITES_LIST=$(echo "{{ suites_status_check.stdout }}" | sed 's/done_but_old://' | xargs)
        for suite in $SUITES_LIST; do
          if [ -n "$suite" ]; then
            PHASE=$(oc get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.status.phase}' 2>&1 || echo "PENDING")
            if [ "$PHASE" != "DONE" ]; then
              ALL_SUITES_DONE=false
              break
            fi
          fi
        done
        if [ "$ALL_SUITES_DONE" = "true" ]; then
          echo "all_done"
        else
          echo "waiting"
        fi
      register: rescanned_suites_status
      changed_when: false
      failed_when: false
      until: rescanned_suites_status.stdout == "all_done"
      retries: "{{ ((wait_timeout | int) / (wait_interval | int)) | int }}"
      delay: "{{ wait_interval | int }}"
      when: 
        - target_cluster_context == ''
        - suites_rescanned.stdout is defined
        - suites_rescanned.stdout is defined
        - suites_rescanned.stdout | regex_search('Agregando anotaci√≥n')

    - name: Esperar completaci√≥n de ComplianceSuites (solo si no est√°n DONE y no se forz√≥ re-scan)
      shell: |
        ALL_SUITES_DONE=true
        SUITES=$(oc {{ oc_context_arg }} get compliancesuites -n {{ compliance_namespace }} -o jsonpath='{.items[*].metadata.name}' 2>&1 || echo "")
        if [ -z "$SUITES" ]; then
          ALL_SUITES_DONE=false
        else
          for suite in $SUITES; do
            PHASE=$(oc {{ oc_context_arg }} get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.status.phase}' 2>&1 || echo "PENDING")
            if [ "$PHASE" != "DONE" ]; then
              ALL_SUITES_DONE=false
              break
            fi
          done
        fi
        if [ "$ALL_SUITES_DONE" = "true" ]; then
          echo "all_done"
        else
          echo "waiting"
        fi
      register: suites_completion_status
      changed_when: false
      failed_when: false
      until: suites_completion_status.stdout == "all_done"
      retries: "{{ ((wait_timeout | int) / (wait_interval | int)) | int }}"
      delay: "{{ wait_interval | int }}"
      environment: "{{ oc_environment if (oc_environment is defined and oc_environment != {}) else {} }}"
      when: 
        - target_cluster_context != ''
        - suites_status_check.stdout is defined
        - suites_status_check.stdout != ''
        - suites_status_check.stdout != 'all_done'
        - suites_status_check.stdout != 'done_but_old'
        - not (suites_rescanned.stdout is defined and (suites_rescanned.stdout | regex_search('Agregando anotaci√≥n')))

    - name: Esperar completaci√≥n de ComplianceSuites (contexto actual, solo si no est√°n DONE y no se forz√≥ re-scan)
      shell: |
        ALL_SUITES_DONE=true
        SUITES=$(oc get compliancesuites -n {{ compliance_namespace }} -o jsonpath='{.items[*].metadata.name}' 2>&1 || echo "")
        if [ -z "$SUITES" ]; then
          ALL_SUITES_DONE=false
        else
          for suite in $SUITES; do
            PHASE=$(oc get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.status.phase}' 2>&1 || echo "PENDING")
            if [ "$PHASE" != "DONE" ]; then
              ALL_SUITES_DONE=false
              break
            fi
          done
        fi
        if [ "$ALL_SUITES_DONE" = "true" ]; then
          echo "all_done"
        else
          echo "waiting"
        fi
      register: suites_completion_status
      changed_when: false
      failed_when: false
      until: suites_completion_status.stdout == "all_done"
      retries: "{{ ((wait_timeout | int) / (wait_interval | int)) | int }}"
      delay: "{{ wait_interval | int }}"
      when: 
        - target_cluster_context == ''
        - suites_status_check.stdout is defined
        - suites_status_check.stdout != ''
        - suites_status_check.stdout != 'all_done'
        - suites_status_check.stdout != 'done_but_old'
        - not (suites_rescanned.stdout is defined and (suites_rescanned.stdout | regex_search('Agregando anotaci√≥n')))

    - name: Mostrar estado final de ComplianceSuites
      shell: |
        echo "=== Estado de ComplianceSuites ==="
        SUITES=$(oc {{ oc_context_arg }} get compliancesuites -n {{ compliance_namespace }} -o jsonpath='{.items[*].metadata.name}' 2>&1 || echo "")
        if [ -n "$SUITES" ]; then
          for suite in $SUITES; do
            PHASE=$(oc {{ oc_context_arg }} get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.status.phase}' 2>&1 || echo "UNKNOWN")
            RESULT=$(oc {{ oc_context_arg }} get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.status.result}' 2>&1 || echo "UNKNOWN")
            echo "$suite: PHASE=$PHASE, RESULT=$RESULT"
          done
        else
          echo "No hay ComplianceSuites encontradas"
        fi
      register: suites_final_status
      changed_when: false
      failed_when: false
      environment: "{{ oc_environment if (oc_environment is defined and oc_environment != {}) else {} }}"
      when: target_cluster_context != ''

    - name: Mostrar estado final de ComplianceSuites (contexto actual)
      shell: |
        echo "=== Estado de ComplianceSuites ==="
        SUITES=$(oc get compliancesuites -n {{ compliance_namespace }} -o jsonpath='{.items[*].metadata.name}' 2>&1 || echo "")
        if [ -n "$SUITES" ]; then
          for suite in $SUITES; do
            PHASE=$(oc get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.status.phase}' 2>&1 || echo "UNKNOWN")
            RESULT=$(oc get compliancesuite "$suite" -n {{ compliance_namespace }} -o jsonpath='{.status.result}' 2>&1 || echo "UNKNOWN")
            echo "$suite: PHASE=$PHASE, RESULT=$RESULT"
          done
        else
          echo "No hay ComplianceSuites encontradas"
        fi
      register: suites_final_status
      changed_when: false
      failed_when: false
      when: target_cluster_context == ''

    - name: Mostrar resumen de ComplianceSuites
      debug:
        msg: "{{ suites_final_status.stdout | default('No se pudo obtener el estado de ComplianceSuites') }}"
      when: suites_final_status is defined and suites_final_status.stdout is defined

    - name: Informar que las ComplianceSuites completaron
      debug:
        msg: "‚úÖ Todas las ComplianceSuites completaron su ejecuci√≥n. Los PVCs deber√≠an estar listos para exportar."

